
# Run-Density — v1.3.4 Recap & v1.3.5 Workplan

_Last updated: today_

## Ground rules we’re keeping
- **Single canonical key:** `seg_id` only (never `segment_id`).
- **Start times:** JSON payload uses `{"Full":…, "Half":…, "10K":…}`; model exposes `TenK` internally via alias.
- **Ports:** local dev on **8081** (Makefile enforces) and Cloud Run service URL unchanged.
- **Data inputs:** `overlaps.csv` is source of truth; inline `segments` supported but not used for prod runs.
- **API surface (stable):**  
  - `POST /api/health` → `{"ok": true}`  
  - `POST /api/ready`  → `{"ok": true, "density_loaded": true, "overlap_loaded": true}`  
  - `POST /api/density[?seg_id=...]` (core)  
  - `POST /api/peaks.csv[?zoneMetric=areal|crowd]` (CSV export)

---

## What shipped in v1.3.4 (vs. plan)

### Delivered
- **Trace/first-overlap validation**
  - Fixed simultaneous window logic so A/B counts reflect overlapping *at the same clock second*.
  - Added `debug` mode with bounded trace (`trace[:50]`).  
- **Areal vs. Crowd density**
  - Kept **areal** = pax per metre of width (1m longitudinal slice).  
  - Added **crowd_density** = pax per m² (uses `width_m * depth_m`, default depth 3m).
- **Custom zoning**
  - Payload accepts `zones: { areal: [7.5,15,30,50], crowd: [1,2,4,8] }` and `zoneMetric: "areal"|"crowd"`.
  - New helpers `_zone_from_cuts`, `_zone_from_metric`, `_zone_for_density` (default safe fallbacks).
- **Start offsets at the line**
  - Per-runner `start_offset` (sec) applied for `A1/A2/A3` at 0–1.8km to model funnel roll-out.
- **Short-span safety**
  - Per-segment `stepKm` fallback to ensure ≥1 bin even when `to-from < stepKm`.
- **Validation**
  - Stricter 422s for missing start times and invalid segment definitions.
- **Exports & tooling**
  - `POST /api/peaks.csv` returns `seg_id, label, direction, width_m, first_clock/km, peak_*…, areal, crowd, zone`.
  - Make targets: `smoke-local`, `smoke-areal`, `smoke-crowd`, `smoke-short`.
  - CI: deploy & smoke fixed (BASE_URL resolution), all green.

### Deferred (moved to 1.3.5+)
- Bib-level trace outputs (IDs at overlap).
- Lightweight perf guardrails (max segments/runners in debug).
- CLI test-harness like early run-congestion.

---

## v1.3.5 — Scope for a 90‑minute session

Focus on **operational helpfulness** (quick wins), minimal surface change:
1. **New endpoint: `/api/segments.csv`** – dump `overlaps.csv` as canonical CSV (width/direction included).  
   _Why:_ super fast QA & documentation; no need to fetch raw GH in the field.
2. **Query override for zoning** – allow `?zoneMetric=crowd` to override payload (handy for curl/make).  
   _Why:_ avoids editing JSON blocks in Make targets.
3. **Trace limit control** – payload field `debugTraceLimit` (default 50) to cap `trace[:N]`.  
   _Why:_ avoid accidental huge JSON on bi-dir segments.
4. **Makefile convenience:** `smoke-quick` to hit `seg_id=A1a,H3` and print one-line summaries.  
5. **Health versioning (optional):** include `version` in `/health` from `APP_VERSION` env.

> All items are independent; we can cut after any two if time runs short.

---

## Ready‑to‑run patches (copy/paste snippets)

> These are **surgical** edits. They assume your repo layout as of v1.3.4. Run from repo root.

### 1) **Add `/api/segments.csv`** (app/main.py)

**Insert** after the existing `/api/peaks.csv` handler:

```python
@app.post("/api/segments.csv")
def api_segments_csv(payload: DensityPayload):
    from app.density import _load_overlaps  # reuse loader
    import io, csv
    overlaps = _load_overlaps(payload.overlapsCsv, payload.segments)
    csv_io = io.StringIO()
    writer = csv.writer(csv_io)
    writer.writerow(["seg_id","segment_label","eventA","eventB","from_km_A","to_km_A","from_km_B","to_km_B","direction","width_m"])
    for s in overlaps:
        writer.writerow([
            s.seg_id, s.segment_label, s.eventA, s.eventB,
            s.from_km_A, s.to_km_A, s.from_km_B, s.to_km_B,
            s.direction, s.width_m
        ])
    return Response(content=csv_io.getvalue(), media_type="text/csv")
```

_No further changes required._

---

### 2) **Allow `?zoneMetric=` to override payload** (app/main.py)

**Replace** your current `api_density`’s first lines with this small merger:

```python
@app.post("/api/density")
def api_density(payload: DensityPayload, request: Request):
    try:
        params = dict(request.query_params)
        seg_id = params.get("seg_id")
        debug  = params.get("debug", "false").lower() == "true"

        # Optional zoneMetric override via query string
        zm = params.get("zoneMetric")
        if zm:
            payload.zoneMetric = zm

        result = run_density(payload, seg_id_filter=seg_id, debug=debug)
        return result
    except HTTPException as he:
        raise he
    except Exception as e:
        return JSONResponse(status_code=500, content={"error": str(e)})
```

_This keeps your existing payload behavior but enables quick CLI flips._

---

### 3) **Trace limit control** (app/density.py)

**A. Add field to `DensityPayload` (near other fields):**
```python
    debugTraceLimit: int = Field(50, gt=0, le=2000)  # cap debug trace rows
```

**B. Use it at result construction (replace existing slice):**
```python
"trace": (trace[:payload.debugTraceLimit] if debug and trace else None),
```

---

### 4) **Makefile: add `smoke-quick` target**

Append at the end of `Makefile`:

```make
smoke-quick:
	@BASE=$${BASE:-http://127.0.0.1:8081}; \
	PACE=$${PACE:-https://raw.githubusercontent.com/thomjeff/run-density/main/data/your_pace_data.csv}; \
	OVLS=$${OVLS:-https://raw.githubusercontent.com/thomjeff/run-density/main/data/overlaps.csv}; \
	for SEG in A1a H3; do \
	  printf '>> %s\n' $$SEG; \
	  printf '{\n  "paceCsv":"%s",\n  "overlapsCsv":"%s",\n  "startTimes":{"Full":420,"Half":460,"10K":440},\n  "stepKm":0.03,\n  "timeWindow":60,\n  "depth_m":3.0\n}\n' "$$PACE" "$$OVLS" \
	  | curl -sS -X POST "$$BASE/api/density?seg_id=$$SEG" -H 'Content-Type: application/json' --data @- \
	  | jq -r '.segments[0] | "$${seg_id}\tfirst=$${first_overlap.clock} @ km $${first_overlap.km}\tpeak=$${peak.combined}\tareal=$${peak.areal_density}\tcrowd=$${peak.crowd_density}\t[$${peak.zone}]"'; \
	done
```

_Note: backslashes and tabs preserved; copy as-is._

---

### 5) **Optional: `/health` includes version** (app/main.py)

**A. Import and read env once:**
```python
import os
APP_VERSION = os.getenv("APP_VERSION", "local")
```

**B. Replace health handler body with:**
```python
@app.get("/health")
def health():
    return {"ok": True, "version": APP_VERSION}
```

_Set `APP_VERSION` in Cloud Run env later; local will show `"local"`._

---

## Quick test commands

```bash
# Local sanity
BASE="http://127.0.0.1:8081"
curl -s "$BASE/health" | jq .
curl -s "$BASE/ready"  | jq .

# zoneMetric override via query
curl -s -X POST "$BASE/api/density?zoneMetric=crowd"   -H 'Content-Type: application/json'   -d '{"paceCsv":"https://raw.githubusercontent.com/thomjeff/run-density/main/data/your_pace_data.csv",
       "overlapsCsv":"https://raw.githubusercontent.com/thomjeff/run-density/main/data/overlaps.csv",
       "startTimes":{"Full":420,"Half":460,"10K":440},
       "stepKm":0.03,"timeWindow":60,"depth_m":3.0}' | jq -r '.segments | map(select(.peak.zone!="green")) | .[:6][] | "\(.seg_id)	areal=\(.peak.areal_density)	crowd=\(.peak.crowd_density)	zone=\(.peak.zone)"'

# segments.csv
curl -s -X POST "$BASE/api/segments.csv" -H 'Content-Type: application/json'   -d '{"paceCsv":"https://raw.githubusercontent.com/thomjeff/run-density/main/data/your_pace_data.csv",
       "overlapsCsv":"https://raw.githubusercontent.com/thomjeff/run-density/main/data/overlaps.csv",
       "startTimes":{"Full":420,"Half":460,"10K":440},
       "stepKm":0.03,"timeWindow":60,"depth_m":3.0}' | head
```

---

## Git / PR checklist (repeatable)
```bash
# create feature branch
git checkout -b feat/segments-csv

# edit files, then:
git add app/main.py app/density.py Makefile
git commit -m "feat: segments.csv endpoint + zoneMetric override + trace limit + smoke-quick"

# push & open PR to v1.3.5-dev (or main if you choose)
git push origin feat/segments-csv
# if gh CLI is available:
# gh pr create --base v1.3.5-dev --head feat/segments-csv #   --title "feat: segments.csv + zoneMetric override + trace limit" #   --body  "Quick-win ops features; no breaking changes."
```

---

## Notes / gotchas carried forward
- Keep `seg_id` everywhere (no `segment_id`).
- Avoid reintroducing `_zone_for_areal` or `_trace_segment` symbols; the new helpers are canonical.
- When adding tiny logic, prefer small unified helpers and reuse existing validators.
- Make targets should avoid inline JSON typos; prefer the heredoc/printf patterns in `smoke-*` we adopted.
