<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Runflow ‚Äî System Health</title>
<link rel="stylesheet" href="css/main.css"/>
<style>
  .ok{color:#10b981}.bad{color:#ef4444}.dot{font-weight:700}
  .status-indicator.healthy { color: #10b981; }
  .status-indicator.degraded { color: #f59e0b; }
  .status-indicator.critical { color: #ef4444; }
  .endpoint-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
  }
  .endpoint-status.up { color: #10b981; }
  .endpoint-status.down { color: #ef4444; }
  .endpoint-status.error { color: #ef4444; }
  .health-dashboard {
    max-width: 1200px;
    margin: 0 auto;
  }
  .health-sections {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-top: 1.5rem;
  }
  .health-section {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 6px;
  }
  .system-info {
    margin-bottom: 1rem;
  }
  .info-item {
    margin-bottom: 0.5rem;
  }
  .endpoint-grid {
    display: flex;
    flex-direction: column;
  }
  @media (max-width: 768px) {
    .health-sections {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>
<script>
  // Authentication guard
  if (!sessionStorage.getItem('rf_auth')) {
    window.location.href = 'password.html';
  }
  
  // Check session expiry
  function checkSessionExpiry() {
    const TTL_MS = 8 * 60 * 60 * 1000; // 8 hours
    const now = Date.now();
    const ts = parseInt(sessionStorage.getItem('rf_auth_ts') || '0');
    
    if (ts && (now - ts) > TTL_MS) {
      sessionStorage.clear();
      window.location.href = 'password.html';
    }
  }
  
  // Check on load
  checkSessionExpiry();
  
  // Logout function
  function logout() {
    sessionStorage.clear();
    window.location.href = 'password.html';
  }
</script>

<header class="header header--brand">
  <div class="container header__inner">
    <div><h1 class="brand">Runflow</h1><p class="sub">JSON Health Check</p></div>
    <nav class="top-cta">
      <a class="btn btn--primary" href="index.html">Dashboard</a>
      <a class="btn btn--ghost" href="#" onclick="logout()">Logout</a>
    </nav>
  </div>
</header>

<nav class="nav">
  <div class="container">
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="map.html">Interactive Map</a></li>
      <li><a href="reports.html">Reports</a></li>
      <li><a href="health.html" class="active">Health Check</a></li>
    </ul>
  </div>
</nav>

<main class="container">
  <div class="health-dashboard">
    <section class="card">
      <h2 class="h2">System Health Status</h2>
      <div class="status-overview" style="margin-bottom:20px;padding:12px;background:#f8f9fa;border-radius:6px;font-size:0.95rem">
        <div class="overall-status" id="overall-status">
          <span class="status-indicator">üîÑ Checking...</span>
        </div>
      </div>
      
      <div class="health-sections">
        <!-- System Information -->
        <div class="health-section">
          <h3 class="h3">System Information</h3>
          <div class="system-info" id="version-info">
            <div class="info-item">
              <strong>Version:</strong> <span id="version">Loading...</span>
            </div>
            <div class="info-item">
              <strong>Environment:</strong> <span id="environment">Detecting...</span>
            </div>
          </div>
        </div>
        
        <!-- API Endpoints Status -->
        <div class="health-section">
          <h3 class="h3">API Endpoints</h3>
          <div class="endpoint-grid" id="endpoint-status">
            <!-- Populated by JavaScript -->
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<footer class="footer"><div class="container">&copy; 2025 Runflow</div></footer>

<script>
// Real-time health monitoring using existing API endpoints
async function testEndpoint(url) {
  try {
    const response = await fetch(url, { cache: 'no-store' });
    const data = await response.json();
    return {
      status: response.ok ? 'up' : 'down',
      statusCode: response.status,
      data: data
    };
  } catch (error) {
    return {
      status: 'error',
      error: error.message
    };
  }
}

// Load health data on page load
async function loadHealthData() {
  const healthChecks = {
    basic: await testEndpoint('/health'),
    ready: await testEndpoint('/ready'), 
    dashboard: await testEndpoint('/api/dashboard/summary'),
    segments: await testEndpoint('/api/segments/summary'),
    density: await testEndpoint('/api/density/segments'),
    flow: await testEndpoint('/api/flow/segments'),
    reports: await testEndpoint('/api/reports/list'),
    environment: await testEndpoint('/api/debug/env')
  };
  
  renderHealthDashboard(healthChecks);
}

function determineOverallStatus(checks) {
  const criticalEndpoints = ['basic', 'ready', 'dashboard'];
  const criticalDown = criticalEndpoints.some(ep => checks[ep].status !== 'up');
  
  if (criticalDown) {
    return { class: 'critical', icon: '‚ùå', text: 'Critical Issues' };
  }
  
  const allUp = Object.values(checks).every(check => check.status === 'up');
  if (allUp) {
    return { class: 'healthy', icon: '‚úÖ', text: 'All Systems Operational' };
  }
  
  return { class: 'degraded', icon: '‚ö†Ô∏è', text: 'Some Issues Detected' };
}

function renderHealthDashboard(checks) {
  // Update overall status
  const overallStatus = determineOverallStatus(checks);
  document.getElementById('overall-status').innerHTML = `
    <span class="status-indicator ${overallStatus.class}">${overallStatus.icon} ${overallStatus.text}</span>
  `;
  
  // Version info from /health endpoint
  if (checks.basic.status === 'up' && checks.basic.data) {
    document.getElementById('version').textContent = checks.basic.data.version || 'Unknown';
  }
  
  // Environment info from /api/debug/env
  if (checks.environment.status === 'up' && checks.environment.data) {
    const env = checks.environment.data;
    document.getElementById('environment').textContent = 
      env.enable_bin_dataset ? 'Cloud Run' : 'Local Development';
  } else {
    // Fallback to URL-based detection
    const hostname = window.location.hostname;
    let environment = 'Local Development';
    if (hostname.includes('run.app') || hostname.includes('cloudrun')) {
      environment = 'Cloud Run Production';
    }
    document.getElementById('environment').textContent = environment;
  }
  
  // Render endpoint status
  renderEndpointStatus(checks);
}

function renderEndpointStatus(checks) {
  const endpointGrid = document.getElementById('endpoint-status');
  
  const endpoints = [
    { key: 'basic', name: '/health', description: 'Basic health check' },
    { key: 'ready', name: '/ready', description: 'Service readiness' },
    { key: 'dashboard', name: '/api/dashboard/summary', description: 'System metrics' },
    { key: 'segments', name: '/api/segments/summary', description: 'Segment data' },
    { key: 'density', name: '/api/density/segments', description: 'Density analysis' },
    { key: 'flow', name: '/api/flow/segments', description: 'Flow analysis' },
    { key: 'reports', name: '/api/reports/list', description: 'Report generation' },
    { key: 'environment', name: '/api/debug/env', description: 'Environment info' }
  ];
  
  endpointGrid.innerHTML = endpoints.map(endpoint => {
    const check = checks[endpoint.key];
    const statusClass = check.status === 'up' ? 'up' : (check.status === 'down' ? 'down' : 'error');
    const statusText = check.status === 'up' ? 'Up' : (check.status === 'down' ? `Down (${check.statusCode})` : 'Error');
    const errorText = check.error ? ` - ${check.error}` : '';
    
    return `
      <div class="endpoint-item">
        <div>
          <code>${endpoint.name}</code>
          <div style="font-size: 0.8rem; color: #666; margin-top: 0.2rem;">${endpoint.description}</div>
        </div>
        <div class="endpoint-status ${statusClass}">${statusText}${errorText}</div>
      </div>
    `;
  }).join('');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', loadHealthData);
</script>
</body>
</html>
