{% extends "base.html" %}

{% block title %}Segments{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #segments-map {
        height: 500px;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        background: transparent !important;
    }
    
    .map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 1rem 2rem;
        border-radius: 4px;
        font-weight: 500;
        color: #666;
    }
    
    
    .segment-tooltip {
        font-size: 0.875rem;
        line-height: 1.4;
    }
    
    .segment-tooltip .segment-id {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .segment-tooltip .segment-metrics {
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Course Segments</h2>
    {% if meta %}
    {% endif %}
</div>

<!-- Map Container -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Course Map</h3>
    <div id="segments-map" aria-label="Course segments map" style="position: relative;">
        <div class="map-loading">Loading map data...</div>
        
        <!-- Filter Controls Overlay -->
        <div id="map-filter-controls" style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(255, 255, 255, 0.95); padding: 0.75rem; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: none; max-width: 300px;">
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                <button id="clear-filter-btn" onclick="clearMapFilter()" style="padding: 0.4rem 0.8rem; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                    Clear Filter
                </button>
                <span id="filter-status" style="color: #495057; font-size: 0.85rem; text-align: right; line-height: 1.3;"></span>
            </div>
        </div>

        <!-- Heatmap Preview Overlay -->
        <div id="heatmap-overlay" style="position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 0.75rem; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); width: 260px; display: none;">
            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50;">Heatmap</div>
            <div id="heatmap-status" style="font-size: 0.9rem; color: #555; margin-bottom: 0.5rem;">Select a segment to view heatmap.</div>
            <img id="heatmap-image" alt="Segment heatmap" style="width: 100%; border-radius: 4px; border: 1px solid #e0e0e0; display: none;" />
        </div>
    </div>
</div>

<!-- Segment Metadata Table -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Segment Metadata</h3>
    <table id="segments-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Length (km)</th>
                <th>Width (m)</th>
                <th>Direction</th>
                <th>Events</th>
                <th>LOS</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="8" class="placeholder">Loading segment data...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Level of Service (LOS) Reference -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Level of Service (LOS) Reference</h3>
    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">Defined by areal density (ρ) in persons per square meter (p/m²).</p>
    <table>
        <thead>
            <tr>
                <th>LOS</th>
                <th>Density Range (p/m²)</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><span class="badge-los badge-A">A</span></td>
                <td>0.00 – 0.36</td>
                <td>Free Flow</td>
            </tr>
            <tr>
                <td><span class="badge-los badge-B">B</span></td>
                <td>0.36 – 0.54</td>
                <td>Comfortable</td>
            </tr>
            <tr>
                <td><span class="badge-los badge-C">C</span></td>
                <td>0.54 – 0.72</td>
                <td>Moderate</td>
            </tr>
            <tr>
                <td><span class="badge-los badge-D">D</span></td>
                <td>0.72 – 1.08</td>
                <td>Dense</td>
            </tr>
            <tr>
                <td><span class="badge-los badge-E">E</span></td>
                <td>1.08 – 1.63</td>
                <td>Very Dense</td>
            </tr>
            <tr>
                <td><span class="badge-los badge-F">F</span></td>
                <td>1.63+</td>
                <td>Extremely Dense</td>
            </tr>
        </tbody>
    </table>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- External JavaScript modules (cache-busted for latest fixes) -->
<script src="/static/js/map/base_map.js"></script>
<script src="/static/js/map/segments.js?v=2025-12-13T2125Z"></script>

<!-- Table interaction script -->
<script>
    // Table interaction functionality (preserved from original)
    // Get focus parameter from URL
    const urlParams = new URLSearchParams(window.location.search);
    const focusSegmentId = urlParams.get('focus');
    
    function currentDayAndRun() {
        const params = new URLSearchParams(window.location.search);
        const dayParam = params.get('day');
        const runParam = params.get('run_id');
        const day = dayParam ? dayParam.toLowerCase() : (window.runflowDay && window.runflowDay.selected);
        const run_id = runParam || (window.runflowDay && window.runflowDay.run_id);
        return { day, run_id };
    }
    
    function rebuildApiUrl(basePath) {
        const { day, run_id } = currentDayAndRun();
        const u = new URL(basePath, window.location.origin);
        if (day) u.searchParams.set('day', day);
        if (run_id) u.searchParams.set('run_id', run_id);
        return u.pathname + u.search;
    }
    
    // Ensure run_id is present; if missing, fetch from dashboard summary and rewrite URL
    async function ensureRunAndDayInUrl() {
        const params = new URLSearchParams(window.location.search);
        let runId = params.get('run_id');
        let dayParam = params.get('day');
        if (runId) return; // already present

        try {
            const resp = await fetch('/api/dashboard/summary', { cache: 'no-store' });
            const data = await resp.json();
            runId = data.run_id || runId;
            const selectedDay = (dayParam || data.selected_day || '').toLowerCase();
            const p = new URLSearchParams(window.location.search);
            if (runId) p.set('run_id', runId);
            if (selectedDay) p.set('day', selectedDay);
            const newUrl = window.location.pathname + (p.toString() ? '?' + p.toString() : '');
            if (newUrl !== window.location.pathname + window.location.search) {
                window.location.replace(newUrl);
            }
        } catch (e) {
            console.warn('Failed to resolve run_id for segments page', e);
        }
    }

    // Initialize table interactions when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        ensureRunAndDayInUrl().then(() => {
            // Wait for map to be initialized by segments.js
            setTimeout(() => {
                // Get references to map and segments layer from global scope
                map = window.map || null;
                segmentsLayer = window.segmentsLayer;
                
                if (focusSegmentId) {
                    focusOnSegment(focusSegmentId);
                }
            }, 100);
            
            // Force reload of map data with day/run_id when day selector changes
            const daySelector = document.getElementById('day-selector');
            if (daySelector) {
                daySelector.addEventListener('change', () => {
                    const day = daySelector.value || '';
                    const params = new URLSearchParams(window.location.search);
                    if (day) params.set('day', day);
                    else params.delete('day');
                    const { run_id } = currentDayAndRun();
                    if (run_id) params.set('run_id', run_id);
                    const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
                    window.location.href = newUrl;
                });
            }
        });
    });
    
    function focusOnSegment(segmentId) {
        if (!segmentsLayer) return;
        
        segmentsLayer.eachLayer(function(layer) {
            if (layer.feature.properties.seg_id === segmentId) {
                // Highlight the segment
                layer.setStyle({
                    weight: 6,
                    opacity: 1.0
                });
                
                // Fit bounds to this segment
                map.fitBounds(layer.getBounds(), { padding: [50, 50] });
                
                // Open tooltip
                layer.openTooltip();
                
                // Highlight in table
                highlightSegmentInTable(segmentId);
            }
        });
    }
    
    function highlightSegmentInTable(segmentId) {
        // Remove existing highlights
        document.querySelectorAll('#segments-table tr.highlighted').forEach(row => {
            row.classList.remove('highlighted');
        });
        
        // Find and highlight the row
        const rows = document.querySelectorAll('#segments-table tbody tr');
        rows.forEach(row => {
            const idCell = row.querySelector('td:first-child');
            if (idCell && idCell.textContent === segmentId) {
                row.classList.add('highlighted');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    }
    
    // Make functions globally available for external scripts
    window.focusOnSegment = focusOnSegment;
    window.highlightSegmentInTable = highlightSegmentInTable;
</script>

<style>
    /* Table row highlighting */
    #segments-table tr.highlighted {
        background-color: #e3f2fd !important;
        border-left: 4px solid #2196f3;
    }
    
    #segments-table tbody tr {
        cursor: pointer;
    }
    
    #segments-table tbody tr:hover {
        background-color: #f5f5f5;
    }
</style>
{% endblock %}

