{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Dashboard</h2>
    <div style="display: flex; align-items: center; gap: 1rem;">
    </div>
</div>

<!-- Data Missing Banner -->
<div id="data-missing-banner" class="card" style="display: none; margin-bottom: 1.5rem;">
    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border-radius: 4px; background: #fff3cd; border-left: 4px solid #ffc107;">
        <span style="font-size: 1.25rem;">⚠️</span>
        <div>
            <div style="font-weight: 600; color: #856404;">Data Not Found</div>
            <div id="data-missing-message" style="font-size: 0.875rem; color: #856404;">Data not found for one or more inputs (meta.json, metrics, or flags). Showing placeholders.</div>
        </div>
    </div>
</div>


<!-- Model Inputs Section -->
<div class="card">
    <h3 style="margin-bottom: 1.5rem; color: #2c3e50;">Model Inputs</h3>
    <div id="events-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <!-- Dynamic event tiles injected via JS -->
    </div>
    <div style="margin-top: 1rem;">
        <div id="metric-segments" class="kpi">
            <div class="kpi-value">—</div>
            <div class="kpi-label">Course Segments</div>
        </div>
    </div>
</div>

<!-- Model Outputs Section -->
<div class="card">
    <h3 style="margin-bottom: 1.5rem; color: #2c3e50;">Model Outputs</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
        
        <div id="status-banner" class="kpi" style="display: none;">
            <div id="status-icon" class="kpi-value" style="font-size: 1.5rem;">⚠️</div>
            <div id="status-title" class="kpi-label">Action Required</div>
            <div id="status-message" class="kpi-label">HIGH DENSITY OR FLAGGED SEGMENTS DETECTED</div>
        </div>
        
        <div class="kpi">
            <div id="metric-total-runners" class="kpi-value">—</div>
            <div class="kpi-label">Total Participants</div>
        </div>
        
        <div class="kpi">
            <div id="kpi-peak-density" class="kpi-value">—</div>
            <div class="kpi-label">Peak Density (p/m²)</div>
            <div id="kpi-peak-density-los" style="margin-top: 0.25rem;">
                <span class="badge-los badge-A">—</span>
            </div>
        </div>
        
        <div class="kpi">
            <div id="kpi-peak-rate" class="kpi-value">—</div>
            <div class="kpi-label">Peak Rate (p/s)</div>
        </div>
        
        <div class="kpi">
            <div id="kpi-flagged-segments" class="kpi-value">—</div>
            <div class="kpi-label">Segments with Flags</div>
        </div>
        
        <div class="kpi">
            <div id="kpi-flagged-bins" class="kpi-value">—</div>
            <div class="kpi-label">Flagged Bins</div>
        </div>
        
        <div class="kpi">
            <div id="kpi-overtaking" class="kpi-value">—</div>
            <div class="kpi-label">Overtaking Segments</div>
        </div>
        
        <div class="kpi">
            <div id="kpi-copresence" class="kpi-value">—</div>
            <div class="kpi-label">Co-presence Segments</div>
        </div>
        
    </div>
</div>

<!-- Last Updated -->
<div style="text-align: center; margin-top: 2rem; color: #7f8c8d; font-size: 0.875rem;">
    Last updated: <span id="last-updated">Loading...</span>
</div>

{% endblock %}

{% block extra_styles %}
<style>
    @media (max-width: 768px) {
        main .kpi {
            min-width: 150px;
        }
        
        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
    }
    
    
    .status-normal {
        background: #d5f4e6;
        border-left: 4px solid #2ecc71;
    }
    
    .status-action-required {
        background: #fdf2f2;
        border-left: 4px solid #e74c3c;
    }
    
    /* LOS Badge Styles */
    .badge-los {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: white;
    }
    
    .badge-A { background-color: #2ecc71; }
    .badge-B { background-color: #f39c12; }
    .badge-C { background-color: #e67e22; }
    .badge-D { background-color: #e74c3c; }
    .badge-E { background-color: #9b59b6; }
    .badge-F { background-color: #34495e; }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    // Dashboard data binding
    let dashboardData = null;
    
    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        
    });
    
    function currentDaySelection() {
        if (window.runflowDay && window.runflowDay.selected) {
            return window.runflowDay.selected;
        }
        const params = new URLSearchParams(window.location.search);
        const d = params.get("day");
        if (d) return d.toLowerCase();
        const stored = localStorage.getItem("selected_day");
        return stored ? stored.toLowerCase() : null;
    }
    
    function loadDashboardData() {
        // Show loading state
        showLoadingState();
        
        const day = currentDaySelection();
        const url = day ? `/api/dashboard/summary?day=${encodeURIComponent(day)}` : '/api/dashboard/summary';
        fetch(url)
            .then(response => response.json())
            .then(data => {
                dashboardData = data;
                updateDashboard(data);
            })
            .catch(error => {
                console.error('Error loading dashboard data:', error);
                showErrorState();
            });
    }
    
    function showLoadingState() {
        // Show loading indicators
        document.querySelectorAll('.kpi-value').forEach(el => {
            el.textContent = '—';
        });
        document.getElementById('last-updated').textContent = 'Loading...';
    }
    
    function showErrorState() {
        // Show error indicators
        document.querySelectorAll('.kpi-value').forEach(el => {
            el.textContent = 'Error';
        });
        document.getElementById('last-updated').textContent = 'Error loading data';
    }
    
    function updateDashboard(data) {
        console.log('updateDashboard called with data:', data);
        
        // Update timestamp
        document.getElementById('last-updated').textContent = formatTimestamp(data.timestamp);
        
        // Update data missing banner
        updateDataMissingBanner(data);
        
        // Update status banner
        updateStatusBanner(data);
        
        // Update model inputs
        updateModelInputs(data);
        
        // Update model outputs
        updateModelOutputs(data);
    }
    
    function updateDataMissingBanner(data) {
        const banner = document.getElementById('data-missing-banner');
        const message = document.getElementById('data-missing-message');
        
        if (data.warnings && data.warnings.length > 0) {
            banner.style.display = 'block';
            const missingFiles = data.warnings.filter(w => w.startsWith('missing:')).map(w => w.replace('missing: ', ''));
            if (missingFiles.length > 0) {
                message.textContent = `Data not found for: ${missingFiles.join(', ')}. Showing placeholders.`;
            } else {
                message.textContent = 'Data loading issues detected. Showing placeholders.';
            }
        } else if (data.segments_total === 0 && data.total_runners === 0) {
            banner.style.display = 'block';
            message.textContent = 'No data available. Showing placeholders.';
        } else {
            banner.style.display = 'none';
        }
    }
    
    function updateStatusBanner(data) {
        const banner = document.getElementById('status-banner');
        const icon = document.getElementById('status-icon');
        const title = document.getElementById('status-title');
        const message = document.getElementById('status-message');
        
        if (data.status === 'action_required') {
            banner.style.display = 'block';
            icon.textContent = '⚠️';
            title.textContent = 'ACTION REQUIRED';
            title.style.color = '#e74c3c';
            message.textContent = 'HIGH DENSITY OR FLAGGED SEGMENTS DETECTED';
        } else {
            banner.style.display = 'block';
            icon.textContent = '✅';
            title.textContent = 'NORMAL OPERATIONS';
            title.style.color = '#2ecc71';
            message.textContent = 'ALL SYSTEMS OPERATING WITHIN NORMAL PARAMETERS';
        }
    }
    
    function updateModelInputs(data) {
        // Dynamic event tiles based on selected day
        const container = document.getElementById('events-container');
        if (container) {
            container.innerHTML = '';
            const events = Array.isArray(data.events) ? data.events : [];
            events.forEach(ev => {
                const evKey = ev.toLowerCase();
                const count = (data.cohorts && data.cohorts[evKey] && typeof data.cohorts[evKey].count === 'number')
                    ? data.cohorts[evKey].count
                    : 0;
                const card = document.createElement('div');
                card.className = 'kpi event-card';
                card.innerHTML = `
                    <div class="kpi-label">${ev.toUpperCase()}</div>
                    <div class="kpi-value">${count.toLocaleString()}</div>
                    <div class="kpi-subtext">${count === 1 ? 'PARTICIPANT' : 'PARTICIPANTS'}</div>
                `;
                container.appendChild(card);
            });
        }
        
        // Segments
        const segmentsEl = document.querySelector('#metric-segments .kpi-value');
        if (segmentsEl) {
            segmentsEl.textContent = data.segments_total;
        }
    }
    
    function updateModelOutputs(data) {
        console.log('updateModelOutputs called with data:', data);
        
        // Total runners (moved from Model Inputs)
        const totalRunnersEl = document.querySelector('#metric-total-runners');
        if (totalRunnersEl) {
            totalRunnersEl.textContent = data.total_runners.toLocaleString();
        }
        
        // Peak density with LOS badge
        const peakDensityEl = document.querySelector('#kpi-peak-density');
        console.log('peakDensityEl found:', peakDensityEl);
        if (peakDensityEl) {
            peakDensityEl.textContent = data.peak_density.toFixed(3);
            console.log('Set peak density to:', data.peak_density.toFixed(3));
        }
        
        const losBadgeEl = document.querySelector('#kpi-peak-density-los .badge-los');
        if (losBadgeEl) {
            losBadgeEl.textContent = data.peak_density_los;
            losBadgeEl.className = `badge-los badge-${data.peak_density_los}`;
        }
        
        // Peak rate
        const peakRateEl = document.querySelector('#kpi-peak-rate');
        if (peakRateEl) {
            peakRateEl.textContent = data.peak_rate.toFixed(2);
        }
        
        // Flagged segments
        const flaggedSegmentsEl = document.querySelector('#kpi-flagged-segments');
        if (flaggedSegmentsEl) {
            const flaggedSegmentsText = `${data.segments_flagged} / ${data.segments_total}`;
            flaggedSegmentsEl.textContent = flaggedSegmentsText;
        }
        
        // Flagged bins
        const flaggedBinsEl = document.querySelector('#kpi-flagged-bins');
        if (flaggedBinsEl) {
            flaggedBinsEl.textContent = data.bins_flagged.toLocaleString();
        }
        
        // Overtaking segments
        const overtakingEl = document.querySelector('#kpi-overtaking');
        if (overtakingEl) {
            overtakingEl.textContent = data.segments_overtaking;
        }
        
        // Co-presence segments
        const copresenceEl = document.querySelector('#kpi-copresence');
        if (copresenceEl) {
            copresenceEl.textContent = data.segments_copresence;
        }
    }
    
    function formatTimestamp(timestamp) {
        try {
            const date = new Date(timestamp);
            return date.toLocaleString();
        } catch (e) {
            return timestamp;
        }
    }
</script>
{% endblock %}

