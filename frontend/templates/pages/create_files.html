{% extends "base.html" %}

{% block title %}Create Files{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Create New Data Files</h2>
</div>

<!-- Error Banner -->
<div id="error-banner" class="card" style="display: none; background: #fee; border-left: 4px solid #e74c3c; margin-bottom: 1.5rem;">
    <h3 style="color: #e74c3c; margin-bottom: 0.5rem;">Error</h3>
    <p id="error-message" style="color: #c0392b; margin: 0;"></p>
</div>

<!-- Create New Data Files Section (Issue #676) -->
<div class="card" style="margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1rem;">Create New Data Files</h3>
    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
        Generate new runner CSV files with scenario-based modifications (participant counts and pace adjustments).
    </p>
    
    <!-- Step 1: File Selection -->
    <div id="baseline-step1" style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
            Select Runner Files <span style="color: #e74c3c;">*</span>
        </label>
        <div id="baseline-file-selection" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 1rem;">
            <!-- Checkboxes will be populated by JavaScript -->
        </div>
        <button 
            type="button" 
            id="baseline-calculate-btn"
            style="padding: 0.75rem 2rem; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;"
            disabled
        >
            Calculate Baseline
        </button>
        <div class="field-error" id="baseline-file-selection-error" style="display: none; color: #e74c3c; font-size: 0.875rem; margin-top: 0.5rem;"></div>
    </div>
    
    <!-- Step 2: Baseline Metrics Table (hidden until calculated) -->
    <div id="baseline-step2" style="display: none; margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 1rem; color: #2c3e50;">Baseline Metrics</h4>
        <div id="baseline-metrics-table" style="overflow-x: auto;">
            <!-- Table will be populated by JavaScript -->
        </div>
    </div>
    
    <!-- Step 3: Control Variables Input (hidden until baseline calculated) -->
    <div id="baseline-step3" style="display: none; margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 1rem; color: #2c3e50;">Control Variables</h4>
        <div id="baseline-control-variables-table" style="overflow-x: auto;">
            <!-- Table will be populated by JavaScript -->
        </div>
        <div class="field-error" id="baseline-control-variables-error" style="display: none; color: #e74c3c; font-size: 0.875rem; margin-top: 0.5rem;"></div>
        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
            <button 
                type="button" 
                id="baseline-calculate-new-btn"
                style="padding: 0.75rem 2rem; background: #2ecc71; color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;"
            >
                Calculate New Baseline
            </button>
            <button 
                type="button" 
                id="baseline-clear-btn"
                style="padding: 0.75rem 2rem; background: #95a5a6; color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;"
            >
                Clear
            </button>
        </div>
    </div>
    
    <!-- Step 4: New Baseline Metrics Table (hidden until new baseline calculated) -->
    <div id="baseline-step4" style="display: none; margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 1rem; color: #2c3e50;">New Baseline Metrics</h4>
        <div id="baseline-new-metrics-table" style="overflow-x: auto;">
            <!-- Table will be populated by JavaScript -->
        </div>
        
        <!-- File Name Suffix Input -->
        <div style="margin-top: 1.5rem; margin-bottom: 1rem;">
            <label for="baseline-file-suffix" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                File Name Suffix <span style="color: #95a5a6; font-weight: normal;">(optional)</span>
            </label>
            <input 
                type="text" 
                id="baseline-file-suffix" 
                placeholder="_issue676"
                maxlength="50"
                pattern="^[a-zA-Z0-9_-]*$"
                style="width: 100%; max-width: 400px; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; font-family: monospace;"
            >
            <small style="color: #7f8c8d; font-size: 0.875rem; display: block; margin-top: 0.25rem;">
                Text to append to file names (e.g., "_issue676" → elite_runners_issue676.csv). Only letters, numbers, underscores, and hyphens allowed.
            </small>
        </div>
        
        <div style="margin-top: 1rem;">
            <button 
                type="button" 
                id="baseline-create-files-btn"
                style="padding: 0.75rem 2rem; background: #e74c3c; color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;"
            >
                Create New Files
            </button>
        </div>
        
        <!-- Success Message (shown after files are created) -->
        <div id="baseline-success-message" style="display: none; margin-top: 1.5rem; padding: 1rem; background: #efe; border-left: 4px solid #2ecc71; border-radius: 4px;">
            <p style="color: #27ae60; margin: 0 0 0.5rem 0; font-weight: 600;">New File(s) created</p>
            <p id="baseline-file-path" style="color: #2c3e50; margin: 0 0 0.75rem 0; font-family: monospace; font-size: 0.9rem;"></p>
            <a id="baseline-download-link" href="#" style="display: inline-block; padding: 0.5rem 1rem; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-weight: 600;">
                Download All Files
            </a>
        </div>
    </div>
</div>

<!-- Control Variables Reference (anchored at bottom) -->
<div class="card" id="control-variables-reference" style="display: none;">
    <h3 style="margin-bottom: 1rem;">Control Variables Reference</h3>
    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
        Definitions for key metrics and validation rules in the control variables table.
    </p>
    <div id="baseline-reference-table">
        <!-- Reference table will be populated by JavaScript -->
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    // Baseline state (Issue #676)
    let baselineState = {
        runId: null,
        baselineMetrics: null,
        selectedFiles: [],
        controlVariables: null,
        newBaselineMetrics: null
    };

    // Load runner files for baseline selection
    async function loadRunnerFilesForBaseline() {
        try {
            const response = await fetch('/api/data/files?extension=csv');
            if (response.ok) {
                const data = await response.json();
                const runnerFiles = (data.files || []).filter(f => f.endsWith('_runners.csv'));
                renderBaselineFileSelection(runnerFiles);
            }
        } catch (error) {
            console.error('Error loading runner files:', error);
        }
    }
    
    // Render file selection checkboxes
    function renderBaselineFileSelection(files) {
        const container = document.getElementById('baseline-file-selection');
        if (!container) return;
        container.innerHTML = '';
        
        files.forEach(file => {
            const label = document.createElement('label');
            label.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; cursor: pointer;';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = file;
            checkbox.addEventListener('change', updateBaselineCalculateButton);
            
            const span = document.createElement('span');
            span.textContent = file;
            
            label.appendChild(checkbox);
            label.appendChild(span);
            container.appendChild(label);
        });
    }
    
    // Update Calculate Baseline button state
    function updateBaselineCalculateButton() {
        const checkboxes = document.querySelectorAll('#baseline-file-selection input[type="checkbox"]');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        const btn = document.getElementById('baseline-calculate-btn');
        if (btn) {
            btn.disabled = checked.length === 0;
        }
    }
    
    // Calculate baseline metrics
    async function calculateBaseline() {
        const checkboxes = document.querySelectorAll('#baseline-file-selection input[type="checkbox"]');
        const selectedFiles = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        if (selectedFiles.length === 0) {
            showBaselineError('Please select at least one runner file');
            return;
        }
        
        const btn = document.getElementById('baseline-calculate-btn');
        btn.disabled = true;
        btn.textContent = 'Calculating...';
        clearBaselineErrors();
        
        try {
            const response = await fetch('/api/baseline/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ selected_files: selectedFiles })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || 'Failed to calculate baseline');
            }
            
            // Store baseline state
            baselineState.runId = data.run_id;
            baselineState.baselineMetrics = data.baseline_metrics;
            baselineState.selectedFiles = selectedFiles;
            baselineState.reportsPath = data.reports_path || 'runflow';  // Store reports_path
            
            // Render baseline metrics table
            renderBaselineMetricsTable(data.baseline_metrics);
            
            // Show step 2 and 3
            document.getElementById('baseline-step2').style.display = 'block';
            document.getElementById('baseline-step3').style.display = 'block';
            
            // Render control variables table
            renderControlVariablesTable(data.baseline_metrics);
            
            // Show reference section (already rendered on page load)
            document.getElementById('control-variables-reference').style.display = 'block';
            
        } catch (error) {
            showBaselineError(error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Calculate Baseline';
        }
    }
    
    // Render baseline metrics table
    function renderBaselineMetricsTable(metrics) {
        const container = document.getElementById('baseline-metrics-table');
        if (!container) return;
        const events = Object.keys(metrics);
        
        if (events.length === 0) {
            container.innerHTML = '<p>No baseline metrics available</p>';
            return;
        }
        
        let html = '<table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;"><thead><tr>';
        html += '<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: left;">Metric</th>';
        events.forEach(event => {
            html += `<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: center;">${event}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        // Participants
        html += '<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">Participants</td>';
        events.forEach(event => {
            html += `<td style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">${metrics[event].base_participants}</td>`;
        });
        html += '</tr>';
        
        // Percentiles
        const percentiles = ['P00 (Lead)', 'P05', 'P25', 'P50 (Median)', 'P75', 'P95', 'P100 (Last)'];
        const percentileKeys = ['base_p00', 'base_p05', 'base_p25', 'base_p50', 'base_p75', 'base_p95', 'base_p100'];
        
        percentiles.forEach((label, idx) => {
            html += `<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">${label}</td>`;
            events.forEach(event => {
                const value = metrics[event][percentileKeys[idx]];
                html += `<td style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">${value.toFixed(2)}</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // Render control variables input table
    function renderControlVariablesTable(metrics) {
        const container = document.getElementById('baseline-control-variables-table');
        if (!container) return;
        const events = Object.keys(metrics);
        
        if (events.length === 0) {
            container.innerHTML = '<p>No events available</p>';
            return;
        }
        
        let html = '<table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;"><thead><tr>';
        html += '<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: left;">Variable</th>';
        events.forEach(event => {
            html += `<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: center;">${event}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        // Participants change
        html += '<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">Participants %</td>';
        events.forEach(event => {
            html += `<td style="padding: 0.5rem; border: 1px solid #ddd;">
                <input type="text" id="chg_participants_${event}" value="0" 
                       placeholder="40" 
                       style="width: 100%; padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
            </td>`;
        });
        html += '</tr>';
        
        // Percentile changes
        const percentileLabels = ['P00 (Lead) %', 'P05 %', 'P25 %', 'P50 (Median) %', 'P75 %', 'P95 %', 'P100 (Last) %'];
        const percentileKeys = ['chg_p00', 'chg_p05', 'chg_p25', 'chg_p50', 'chg_p75', 'chg_p95', 'chg_p100'];
        
        percentileLabels.forEach((label, idx) => {
            html += `<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">${label}</td>`;
            events.forEach(event => {
                html += `<td style="padding: 0.5rem; border: 1px solid #ddd;">
                    <input type="text" id="${percentileKeys[idx]}_${event}" value="0" 
                           placeholder="0.5" 
                           style="width: 100%; padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
                </td>`;
            });
            html += '</tr>';
        });
        
        // Cut-off time (optional)
        html += '<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">Cut-off (hh:mm)</td>';
        events.forEach(event => {
            html += `<td style="padding: 0.5rem; border: 1px solid #ddd;">
                <input type="text" id="cutoff_${event}" placeholder="06:00" pattern="^([0-1][0-9]|2[0-3]):[0-5][0-9]$"
                       style="width: 100%; padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
            </td>`;
        });
        html += '</tr>';
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // Render Control Variables Reference table
    function renderControlVariablesReference() {
        const container = document.getElementById('baseline-reference-table');
        if (!container) return;
        
        let html = '<table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">';
        html += '<thead><tr>';
        html += '<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: left; width: 20%;">Variable</th>';
        html += '<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: left; width: 35%;">Definition</th>';
        html += '<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: left; width: 45%;">Allowed Range</th>';
        html += '</tr></thead><tbody>';
        
        // Participants %
        html += '<tr>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">Participants %</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'The percentage change in the number of participants from the baseline. Enter values as percentages (e.g., 40 for +40%, -20 for -20%).';
        html += '</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'The allowed range is -50% to +200%, meaning any event can have a 50% reduction in participants from baseline, and a 200% increase.';
        html += '</td>';
        html += '</tr>';
        
        // P00 (Lead)
        html += '<tr>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">P00 (Lead) %</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'The percentage change in pace for the fastest runner (lead runner).';
        html += '</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'A negative percentage means faster (lower pace), and a positive number means slower (higher pace). The allowed range is -50% to +200%.';
        html += '</td>';
        html += '</tr>';
        
        // P05
        html += '<tr>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">P05 %</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'The percentage change in pace at the front 5% point.';
        html += '</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'A negative percentage means faster (lower pace), and a positive number means slower (higher pace). The allowed range is -50% to +200%.';
        html += '</td>';
        html += '</tr>';
        
        // P25
        html += '<tr>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">P25 %</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'The percentage change in pace at the 25% point (1 in 4 runners are faster).';
        html += '</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'A negative percentage means faster (lower pace), and a positive number means slower (higher pace). The allowed range is -50% to +200%.';
        html += '</td>';
        html += '</tr>';
        
        // P50 (Median)
        html += '<tr>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">P50 (Median) %</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'The percentage change in pace for the middle runner (half faster, half slower).';
        html += '</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'A negative percentage means faster (lower pace), and a positive number means slower (higher pace). The allowed range is -50% to +200%.';
        html += '</td>';
        html += '</tr>';
        
        // P75
        html += '<tr>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">P75 %</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'The percentage change in pace at the 75% point (3 in 4 runners are faster).';
        html += '</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'A negative percentage means faster (lower pace), and a positive number means slower (higher pace). The allowed range is -50% to +200%.';
        html += '</td>';
        html += '</tr>';
        
        // P95
        html += '<tr>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">P95 %</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'The percentage change in pace near the back (95% of runners are faster).';
        html += '</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'A negative percentage means faster (lower pace), and a positive number means slower (higher pace). The allowed range is -50% to +200%.';
        html += '</td>';
        html += '</tr>';
        
        // P100 (Last)
        html += '<tr>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">P100 (Last) %</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'The percentage change in pace for the slowest runner (last runner).';
        html += '</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'A negative percentage means faster (lower pace), and a positive number means slower (higher pace). The allowed range is -50% to +200%.';
        html += '</td>';
        html += '</tr>';
        
        // Cut-off
        html += '<tr>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">Cut-off (hh:mm)</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'Optional per-event cut-off duration in hours:minutes format (e.g., "06:00" for 6 hours). The system validates that the slowest runner\'s finish time does not exceed this cut-off before generating files. If validation fails, file generation is blocked with a clear error message.';
        html += '</td>';
        html += '<td style="padding: 0.5rem; border: 1px solid #ddd;">';
        html += 'Optional';
        html += '</td>';
        html += '</tr>';
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // Parse and convert percentage input to decimal
    // Accepts: "40", "40%", "0.5", "0.5%", "-0.5", "-0.5%"
    // Returns: decimal fraction (40 → 0.40, 0.5 → 0.005)
    function parsePercentToDecimal(inputValue) {
        if (!inputValue || inputValue.trim() === '') {
            return 0;
        }
        
        // Trim whitespace and remove optional trailing "%"
        let cleaned = inputValue.trim().replace(/%$/, '');
        
        // Parse as float
        const percentValue = parseFloat(cleaned);
        
        if (isNaN(percentValue)) {
            throw new Error(`Invalid percentage value: "${inputValue}"`);
        }
        
        // Convert percent to decimal: 40 → 0.40, 0.5 → 0.005
        return percentValue / 100;
    }
    
    // Validate percentage input in percent units (-50 to +200)
    function validatePercentRange(percentValue, fieldName) {
        if (percentValue < -50 || percentValue > 200) {
            throw new Error(
                `${fieldName} must be between -50% and +200% (entered: ${percentValue}%)`
            );
        }
    }
    
    // Calculate new baseline
    async function calculateNewBaseline() {
        if (!baselineState.runId || !baselineState.baselineMetrics) {
            showBaselineError('Please calculate baseline first');
            return;
        }
        
        const events = Object.keys(baselineState.baselineMetrics);
        const controlVariables = {};
        
        try {
            // Collect control variables from inputs and convert percent to decimal
            events.forEach(event => {
                // Parse participants %
                const participantsInput = document.getElementById(`chg_participants_${event}`).value;
                const participantsPercent = parseFloat(participantsInput.trim().replace(/%$/, '')) || 0;
                validatePercentRange(participantsPercent, `Participants % for '${event}'`);
                const chg_participants = parsePercentToDecimal(participantsInput);
                
                // Parse percentile changes
                const percentileKeys = ['chg_p00', 'chg_p05', 'chg_p25', 'chg_p50', 'chg_p75', 'chg_p95', 'chg_p100'];
                const percentileLabels = ['P00 %', 'P05 %', 'P25 %', 'P50 %', 'P75 %', 'P95 %', 'P100 %'];
                const percentileValues = {};
                
                percentileKeys.forEach((key, idx) => {
                    const input = document.getElementById(`${key}_${event}`).value;
                    const percentValue = parseFloat(input.trim().replace(/%$/, '')) || 0;
                    validatePercentRange(percentValue, `${percentileLabels[idx]} for '${event}'`);
                    percentileValues[key] = parsePercentToDecimal(input);
                });
                
                controlVariables[event] = {
                    chg_participants: chg_participants,
                    chg_p00: percentileValues.chg_p00,
                    chg_p05: percentileValues.chg_p05,
                    chg_p25: percentileValues.chg_p25,
                    chg_p50: percentileValues.chg_p50,
                    chg_p75: percentileValues.chg_p75,
                    chg_p95: percentileValues.chg_p95,
                    chg_p100: percentileValues.chg_p100
                };
                
                // Optional cut-off time
                const cutoffInput = document.getElementById(`cutoff_${event}`);
                if (cutoffInput && cutoffInput.value.trim()) {
                    controlVariables[event].cutoff_mins = cutoffInput.value.trim();
                }
            });
        } catch (validationError) {
            showBaselineControlError(validationError.message);
            return;
        }
        
        const btn = document.getElementById('baseline-calculate-new-btn');
        btn.disabled = true;
        btn.textContent = 'Calculating...';
        // Clear only control variables errors (not file selection errors)
        const controlErrorEl = document.getElementById('baseline-control-variables-error');
        if (controlErrorEl) {
            controlErrorEl.style.display = 'none';
        }
        
        try {
            const response = await fetch('/api/baseline/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    baseline_run_id: baselineState.runId,
                    control_variables: controlVariables
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || 'Failed to generate new baseline');
            }
            
            // Store new baseline metrics
            baselineState.controlVariables = controlVariables;
            baselineState.newBaselineMetrics = data.updated_baseline_json.new_baseline_metrics;
            
            // Render new baseline metrics table
            renderNewBaselineMetricsTable(data.updated_baseline_json.new_baseline_metrics);
            
            // Show step 4
            document.getElementById('baseline-step4').style.display = 'block';
            
        } catch (error) {
            // Handle API errors - convert backend decimal error messages to percent if needed
            let errorMessage = error.message;
            
            // Convert backend validation errors from decimal to percent format
            errorMessage = errorMessage.replace(
                /out of range \((-?\d+\.?\d*) to (\+?\d+\.?\d*)\)/g,
                (match, min, max) => {
                    const minPercent = (parseFloat(min) * 100).toFixed(0);
                    const maxPercent = (parseFloat(max) * 100).toFixed(0);
                    return `out of range (${minPercent}% to ${maxPercent}%)`;
                }
            );
            
            showBaselineControlError(errorMessage);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Calculate New Baseline';
        }
    }
    
    // Render new baseline metrics table
    function renderNewBaselineMetricsTable(newMetrics) {
        const container = document.getElementById('baseline-new-metrics-table');
        if (!container) return;
        const events = Object.keys(newMetrics);
        
        if (events.length === 0) {
            container.innerHTML = '<p>No new baseline metrics available</p>';
            return;
        }
        
        let html = '<table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;"><thead><tr>';
        html += '<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: left;">Metric</th>';
        events.forEach(event => {
            html += `<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: center;">${event}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        // Participants
        html += '<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">Participants (new)</td>';
        events.forEach(event => {
            html += `<td style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">${newMetrics[event].new_participants}</td>`;
        });
        html += '</tr>';
        
        // Percentiles
        const percentiles = ['P00 (Lead)', 'P05', 'P25', 'P50 (Median)', 'P75', 'P95', 'P100 (Last)'];
        const percentileKeys = ['new_p00', 'new_p05', 'new_p25', 'new_p50', 'new_p75', 'new_p95', 'new_p100'];
        
        percentiles.forEach((label, idx) => {
            html += `<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">${label}</td>`;
            events.forEach(event => {
                const value = newMetrics[event][percentileKeys[idx]];
                html += `<td style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">${value.toFixed(2)}</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // Create new files
    async function createNewFiles() {
        if (!baselineState.runId) {
            showBaselineError('Please calculate baseline and new baseline first');
            return;
        }
        
        // Files are already created by calculateNewBaseline endpoint
        // Get reports_path from stored state or fetch from API
        let reportsPath = baselineState.reportsPath;
        
        if (!reportsPath) {
            try {
                const filesResponse = await fetch(`/api/baseline/files?run_id=${baselineState.runId}`);
                if (filesResponse.ok) {
                    const filesData = await filesResponse.json();
                    reportsPath = filesData.reports_path || 'runflow';
                    baselineState.reportsPath = reportsPath;  // Store for future use
                } else {
                    reportsPath = 'runflow';  // Fallback
                }
            } catch (error) {
                console.error('Error fetching file list:', error);
                reportsPath = 'runflow';  // Fallback
            }
        }
        
        // Show success message with path and download link
        const filePath = `${reportsPath}/baseline/${baselineState.runId}`;
        const pathElement = document.getElementById('baseline-file-path');
        const downloadLink = document.getElementById('baseline-download-link');
        const successMessage = document.getElementById('baseline-success-message');
        
        if (pathElement) {
            pathElement.textContent = filePath;
        }
        
        if (downloadLink) {
            downloadLink.href = `/api/baseline/download?run_id=${baselineState.runId}`;
        }
        
        if (successMessage) {
            successMessage.style.display = 'block';
            successMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
    
    // Clear baseline state
    function clearBaseline() {
        baselineState = {
            runId: null,
            baselineMetrics: null,
            selectedFiles: [],
            controlVariables: null,
            newBaselineMetrics: null,
            reportsPath: null
        };
        
        // Reset UI
        document.getElementById('baseline-step2').style.display = 'none';
        document.getElementById('baseline-step3').style.display = 'none';
        document.getElementById('baseline-step4').style.display = 'none';
        
        // Hide success message
        const successMessage = document.getElementById('baseline-success-message');
        if (successMessage) {
            successMessage.style.display = 'none';
        }
        
        // Clear file suffix input
        const suffixInput = document.getElementById('baseline-file-suffix');
        if (suffixInput) {
            suffixInput.value = '';
        }
        
        // Uncheck all checkboxes
        document.querySelectorAll('#baseline-file-selection input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        
        updateBaselineCalculateButton();
        clearBaselineErrors();
    }
    
    // Show baseline error (for file selection)
    function showBaselineError(message) {
        const errorEl = document.getElementById('baseline-file-selection-error');
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
    }
    
    // Show baseline control variables error (for Calculate New Baseline)
    function showBaselineControlError(message) {
        const errorEl = document.getElementById('baseline-control-variables-error');
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            // Scroll to error
            errorEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
    
    // Show baseline success (deprecated - now using inline success message)
    function showBaselineSuccess(message) {
        // This function is kept for backward compatibility but is no longer used
        // Success messages are now shown inline below the Create New Files button
    }
    
    // Clear baseline errors
    function clearBaselineErrors() {
        const fileErrorEl = document.getElementById('baseline-file-selection-error');
        if (fileErrorEl) {
            fileErrorEl.style.display = 'none';
        }
        const controlErrorEl = document.getElementById('baseline-control-variables-error');
        if (controlErrorEl) {
            controlErrorEl.style.display = 'none';
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        const calcBtn = document.getElementById('baseline-calculate-btn');
        const calcNewBtn = document.getElementById('baseline-calculate-new-btn');
        const createBtn = document.getElementById('baseline-create-files-btn');
        const clearBtn = document.getElementById('baseline-clear-btn');
        
        if (calcBtn) calcBtn.addEventListener('click', calculateBaseline);
        if (calcNewBtn) calcNewBtn.addEventListener('click', calculateNewBaseline);
        if (createBtn) createBtn.addEventListener('click', createNewFiles);
        if (clearBtn) clearBtn.addEventListener('click', clearBaseline);
        
        // Load runner files for baseline
        loadRunnerFilesForBaseline();
        
        // Render reference table on page load
        renderControlVariablesReference();
    });
})();
</script>
{% endblock %}
