{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Generated Reports</h2>
    {% if meta %}
    {% endif %}
</div>

<!-- Reports Section -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Reports</h3>
    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
        Generated Density, Flow, and Locations analysis reports, sorted by most recent first.
    </p>
    <div id="reports-list">
        <p class="placeholder">Loading reports...</p>
    </div>
</div>

<!-- Data Files Section -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Data Files</h3>
    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
        Input data files used for analysis and validation.
    </p>
    <div id="data-files-list">
        <p class="placeholder">Loading data files...</p>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Load reports on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadReports();
    });
    
    function loadReports() {
        // Get run_id and day from URL or global state
        const params = new URLSearchParams(window.location.search);
        const dayParam = params.get('day');
        const runParam = params.get('run_id');
        
        const day = (dayParam || (window.runflowDay && window.runflowDay.selected) || '').toLowerCase().trim();
        const run_id = (runParam || (window.runflowDay && window.runflowDay.run_id) || '').trim();
        
        // Build API URL - if day is provided, filter by day; otherwise show all days
        let apiUrl = '/api/reports/list';
        const queryParams = [];
        if (run_id) queryParams.push(`run_id=${encodeURIComponent(run_id)}`);
        // Note: We don't pass day parameter - we want to show ALL days for the run_id
        if (queryParams.length) apiUrl += `?${queryParams.join('&')}`;
        
        console.log('Loading reports via API...', { apiUrl, run_id });
        
        fetch(apiUrl, { cache: 'no-store' })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // API now returns {reports, run_id, available_days, days_listed}
                renderReportsList(data.reports || data, data.available_days || []);
            })
            .catch(error => {
                console.error('Error loading reports:', error);
                showReportsError();
            });
    }
    
    function renderReportsList(reports, availableDays) {
        const reportsContainer = document.getElementById('reports-list');
        const dataFilesContainer = document.getElementById('data-files-list');
        
        if (!reports || reports.length === 0) {
            reportsContainer.innerHTML = '<p class="placeholder">No reports available</p>';
            dataFilesContainer.innerHTML = '<p class="placeholder">No data files available</p>';
            return;
        }
        
        // Filter and categorize files
        const relevantReports = reports.filter(r => {
            // Include Density, Flow, and Locations reports (.md and .csv files)
            const isRelevantReport = (r.name.includes('Density') || r.name.includes('Flow') || r.name.includes('Locations')) && 
                                   (r.name.endsWith('.md') || r.name.endsWith('.csv'));
            
            // Exclude technical files
            const isTechnicalFile = r.name.includes('bins.') || 
                                  r.name.includes('map_data_') || 
                                  r.name.includes('segment_windows_') ||
                                  r.name.includes('segments_legacy_') ||
                                  r.name.endsWith('.parquet') ||
                                  r.name.endsWith('.geojson') ||
                                  r.name.endsWith('.json');
            
            return isRelevantReport && !isTechnicalFile;
        });
        
        const dataFiles = reports.filter(r => r.type === 'data_file');
        
        // Sort by day (fri, sat, sun, mon), then by modification time (newest first)
        const dayOrder = ['fri', 'sat', 'sun', 'mon'];
        const sortByDayAndTime = (a, b) => {
            const dayA = a.day || '';
            const dayB = b.day || '';
            const dayIndexA = dayOrder.indexOf(dayA);
            const dayIndexB = dayOrder.indexOf(dayB);
            
            // If both have days, sort by day order
            if (dayIndexA >= 0 && dayIndexB >= 0) {
                if (dayIndexA !== dayIndexB) {
                    return dayIndexA - dayIndexB;
                }
            } else if (dayIndexA >= 0) {
                return -1; // a has day, b doesn't - a comes first
            } else if (dayIndexB >= 0) {
                return 1; // b has day, a doesn't - b comes first
            }
            
            // Same day or no day - sort by time
            const timeA = a.mtime || 0;
            const timeB = b.mtime || 0;
            return timeB - timeA; // Descending order (newest first)
        };
        
        relevantReports.sort(sortByDayAndTime);
        
        // Issue #596: Group data files by extension (CSV first, then GPX), then sort by filename
        dataFiles.sort((a, b) => {
            // Get file extensions (lowercase for comparison)
            const extA = (a.name.split('.').pop() || '').toLowerCase();
            const extB = (b.name.split('.').pop() || '').toLowerCase();
            
            // Define extension order: CSV first, then GPX, then others
            const extOrder = { 'csv': 0, 'gpx': 1 };
            const orderA = extOrder[extA] !== undefined ? extOrder[extA] : 2;
            const orderB = extOrder[extB] !== undefined ? extOrder[extB] : 2;
            
            // First, sort by extension order
            if (orderA !== orderB) {
                return orderA - orderB;
            }
            
            // Same extension - sort by filename (case-insensitive)
            return a.name.localeCompare(b.name, undefined, { sensitivity: 'base' });
        });
        
        // Group reports by day
        const reportsByDay = {};
        relevantReports.forEach(report => {
            const day = report.day || 'unknown';
            if (!reportsByDay[day]) {
                reportsByDay[day] = [];
            }
            reportsByDay[day].push(report);
        });
        
        // Render Reports Section - grouped by day
        if (relevantReports.length > 0) {
            let reportsHtml = '';
            
            // Sort days in order: fri, sat, sun, mon
            const sortedDays = Object.keys(reportsByDay).sort((a, b) => {
                const indexA = dayOrder.indexOf(a);
                const indexB = dayOrder.indexOf(b);
                if (indexA >= 0 && indexB >= 0) return indexA - indexB;
                if (indexA >= 0) return -1;
                if (indexB >= 0) return 1;
                return a.localeCompare(b);
            });
            
            sortedDays.forEach(day => {
                const dayReports = reportsByDay[day];
                const dayLabel = day.toUpperCase();
                
                reportsHtml += `<div style="margin-bottom: 2rem;">`;
                reportsHtml += `<h4 style="margin-bottom: 0.75rem; color: #2c3e50; font-size: 1.1rem; font-weight: 600;">${dayLabel} Reports</h4>`;
                reportsHtml += '<table style="width: 100%; border-collapse: collapse; table-layout: fixed;">';
                reportsHtml += '<thead><tr>';
                reportsHtml += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 45%;">File</th>';
                reportsHtml += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 12%;">Size</th>';
                reportsHtml += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 28%;">Modified</th>';
                reportsHtml += '<th style="text-align: center; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 15%;">Action</th>';
                reportsHtml += '</tr></thead><tbody>';
                
                dayReports.forEach(report => {
                    reportsHtml += renderReportTableRow(report);
                });
                
                reportsHtml += '</tbody></table>';
                reportsHtml += '</div>';
            });
            
            reportsContainer.innerHTML = reportsHtml;
        } else {
            reportsContainer.innerHTML = '<p class="placeholder">No reports available</p>';
        }
        
        // Render Data Files Section
        if (dataFiles.length > 0) {
            let dataFilesHtml = '<table style="width: 100%; border-collapse: collapse; table-layout: fixed;">';
            dataFilesHtml += '<thead><tr>';
            dataFilesHtml += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 45%;">File</th>';
            dataFilesHtml += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 12%;">Size</th>';
            dataFilesHtml += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 28%;">Modified</th>';
            dataFilesHtml += '<th style="text-align: center; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 15%;">Action</th>';
            dataFilesHtml += '</tr></thead><tbody>';
            
            dataFiles.forEach(file => {
                dataFilesHtml += renderDataFileTableRow(file);
            });
            
            dataFilesHtml += '</tbody></table>';
            dataFilesContainer.innerHTML = dataFilesHtml;
        } else {
            dataFilesContainer.innerHTML = '<p class="placeholder">No data files available</p>';
        }
    }
    
    function renderReportTableRow(report) {
        const size = formatFileSize(report.size);
        const mtime = report.mtime ? new Date(report.mtime * 1000).toLocaleString() : 'N/A';
        
        return `
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 0.75rem;">
                    <div style="font-weight: 600; color: #2c3e50;">${report.name}</div>
                    <div style="font-size: 0.875rem; color: #7f8c8d; margin-top: 0.25rem;">${report.description || 'Report file'}</div>
                </td>
                <td style="padding: 0.75rem; color: #666;">${size}</td>
                <td style="padding: 0.75rem; color: #666;">${mtime}</td>
                <td style="padding: 0.75rem; text-align: center;">
                    <a href="/api/reports/download?path=${encodeURIComponent(report.path)}" 
                       class="button"
                       download="${report.name}"
                       style="padding: 0.5rem 1rem; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-size: 0.875rem;">
                        Download
                    </a>
                </td>
            </tr>
        `;
    }
    
    function renderDataFileTableRow(file) {
        const size = formatFileSize(file.size);
        const mtime = file.mtime ? new Date(file.mtime * 1000).toLocaleString() : 'N/A';
        
        return `
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 0.75rem;">
                    <div style="font-weight: 600; color: #2c3e50;">${file.name}</div>
                    <div style="font-size: 0.875rem; color: #7f8c8d; margin-top: 0.25rem;">${file.description || 'Data file'}</div>
                </td>
                <td style="padding: 0.75rem; color: #666;">${size}</td>
                <td style="padding: 0.75rem; color: #666;">${mtime}</td>
                <td style="padding: 0.75rem; text-align: center;">
                    <a href="/api/reports/download?path=${encodeURIComponent(file.path)}" 
                       class="button"
                       download="${file.name}"
                       style="padding: 0.5rem 1rem; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-size: 0.875rem;">
                        Download
                    </a>
                </td>
            </tr>
        `;
    }
    
    function formatFileSize(bytes) {
        if (!bytes) return 'N/A';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function showReportsError() {
        const reportsContainer = document.getElementById('reports-list');
        const dataFilesContainer = document.getElementById('data-files-list');
        reportsContainer.innerHTML = '<p class="placeholder">Error loading reports</p>';
        dataFilesContainer.innerHTML = '<p class="placeholder">Error loading data files</p>';
    }
</script>
{% endblock %}

{% block extra_styles %}
<style>
    .button:hover {
        background: #2980b9;
    }
</style>
{% endblock %}
