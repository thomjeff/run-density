{% extends "base.html" %}

{% block title %}Analysis{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Request Analysis</h2>
</div>

<!-- Error Banner -->
<div id="error-banner" class="card" style="display: none; background: #fee; border-left: 4px solid #e74c3c; margin-bottom: 1.5rem;">
    <h3 style="color: #e74c3c; margin-bottom: 0.5rem;">Error</h3>
    <p id="error-message" style="color: #c0392b; margin: 0;"></p>
</div>

<!-- Success Banner -->
<div id="success-banner" class="card" style="display: none; background: #efe; border-left: 4px solid #2ecc71; margin-bottom: 1.5rem;">
    <h3 style="color: #2ecc71; margin-bottom: 0.5rem;">Analysis Submitted Successfully</h3>
    <p id="success-message" style="color: #27ae60; margin: 0;"></p>
</div>

<!-- Create New Data Files Section (Issue #676) -->
<div class="card" style="margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1rem;">Create New Data Files</h3>
    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
        Generate new runner CSV files with scenario-based modifications (participant counts and pace adjustments).
    </p>
    
    <!-- Step 1: File Selection -->
    <div id="baseline-step1" style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
            Select Runner Files <span style="color: #e74c3c;">*</span>
        </label>
        <div id="baseline-file-selection" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 1rem;">
            <!-- Checkboxes will be populated by JavaScript -->
        </div>
        <button 
            type="button" 
            id="baseline-calculate-btn"
            style="padding: 0.75rem 2rem; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;"
            disabled
        >
            Calculate Baseline
        </button>
        <div class="field-error" id="baseline-file-selection-error" style="display: none; color: #e74c3c; font-size: 0.875rem; margin-top: 0.5rem;"></div>
    </div>
    
    <!-- Step 2: Baseline Metrics Table (hidden until calculated) -->
    <div id="baseline-step2" style="display: none; margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 1rem; color: #2c3e50;">Baseline Metrics</h4>
        <div id="baseline-metrics-table" style="overflow-x: auto;">
            <!-- Table will be populated by JavaScript -->
        </div>
    </div>
    
    <!-- Step 3: Control Variables Input (hidden until baseline calculated) -->
    <div id="baseline-step3" style="display: none; margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 1rem; color: #2c3e50;">Control Variables</h4>
        <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
            Enter percentage changes for participants and pace percentiles. Negative values are permitted.
        </p>
        <div id="baseline-control-variables-table" style="overflow-x: auto;">
            <!-- Table will be populated by JavaScript -->
        </div>
        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
            <button 
                type="button" 
                id="baseline-calculate-new-btn"
                style="padding: 0.75rem 2rem; background: #2ecc71; color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;"
            >
                Calculate New Baseline
            </button>
            <button 
                type="button" 
                id="baseline-clear-btn"
                style="padding: 0.75rem 2rem; background: #95a5a6; color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;"
            >
                Clear
            </button>
        </div>
    </div>
    
    <!-- Step 4: New Baseline Metrics Table (hidden until new baseline calculated) -->
    <div id="baseline-step4" style="display: none; margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 1rem; color: #2c3e50;">New Baseline Metrics</h4>
        <div id="baseline-new-metrics-table" style="overflow-x: auto;">
            <!-- Table will be populated by JavaScript -->
        </div>
        <div style="margin-top: 1rem;">
            <button 
                type="button" 
                id="baseline-create-files-btn"
                style="padding: 0.75rem 2rem; background: #e74c3c; color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;"
            >
                Create New Files
            </button>
        </div>
    </div>
</div>

<!-- Analysis Form -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Analysis Inputs</h3>
    
    <form id="analysis-form">
        <!-- Description -->
        <div style="margin-bottom: 1.5rem;">
            <label for="description" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                Description <span style="color: #95a5a6; font-weight: normal;">(optional)</span>
            </label>
            <input 
                type="text" 
                id="description" 
                name="description" 
                maxlength="254"
                placeholder="Enter a short description for this analysis"
                style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
            >
            <small style="color: #7f8c8d; font-size: 0.875rem;">Maximum 254 characters</small>
            <div class="field-error" id="description-error" style="display: none; color: #e74c3c; font-size: 0.875rem; margin-top: 0.25rem;"></div>
        </div>

        <!-- File Inputs (on same row) -->
        <div class="file-inputs-row" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
            <!-- Segments File -->
            <div>
                <label for="segments_file" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                    Segments File <span style="color: #e74c3c;">*</span>
                </label>
                <select 
                    id="segments_file" 
                    name="segments_file" 
                    required
                    style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
                >
                    <option value="">Select segments file...</option>
                </select>
                <small style="color: #7f8c8d; font-size: 0.875rem;">Select the segments CSV file from the data folder.</small>
                <div class="field-error" id="segments_file-error" style="display: none; color: #e74c3c; font-size: 0.875rem; margin-top: 0.25rem;"></div>
            </div>

            <!-- Flow File -->
            <div>
                <label for="flow_file" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                    Flow File <span style="color: #e74c3c;">*</span>
                </label>
                <select 
                    id="flow_file" 
                    name="flow_file" 
                    required
                    style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
                >
                    <option value="">Select flow file...</option>
                </select>
                <small style="color: #7f8c8d; font-size: 0.875rem;">Select the flow CSV file from the data folder.</small>
                <div class="field-error" id="flow_file-error" style="display: none; color: #e74c3c; font-size: 0.875rem; margin-top: 0.25rem;"></div>
            </div>

            <!-- Locations File -->
            <div>
                <label for="locations_file" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                    Locations File <span style="color: #e74c3c;">*</span>
                </label>
                <select 
                    id="locations_file" 
                    name="locations_file" 
                    required
                    style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
                >
                    <option value="">Select locations file...</option>
                </select>
                <small style="color: #7f8c8d; font-size: 0.875rem;">Select the locations CSV file from the data folder.</small>
                <div class="field-error" id="locations_file-error" style="display: none; color: #e74c3c; font-size: 0.875rem; margin-top: 0.25rem;"></div>
            </div>
        </div>

        <!-- Enable Audit -->
        <div style="margin-bottom: 1.5rem;">
            <label for="enable_audit" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                Enable Audit <span style="color: #95a5a6; font-weight: normal;">(optional)</span>
            </label>
            <select 
                id="enable_audit" 
                name="enable_audit" 
                style="width: 100%; max-width: 200px; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
            >
                <option value="n">No</option>
                <option value="y">Yes</option>
            </select>
            <small style="color: #7f8c8d; font-size: 0.875rem;">Enable audit file generation for detailed analysis debugging.</small>
        </div>

        <!-- Events -->
        <div style="margin-bottom: 1.5rem;">
            <h3 style="margin-bottom: 1rem; color: #2c3e50;">Events</h3>
            <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
                Add at least one event. Use the <strong>+</strong> button to add more events, or <strong>-</strong> to remove.
            </p>
            <div id="events-container">
                <!-- Events will be dynamically added here -->
            </div>
            <div class="field-error" id="events-error" style="display: none; color: #e74c3c; font-size: 0.875rem; margin-top: 0.5rem;"></div>
        </div>

        <!-- Buttons -->
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button 
                type="button" 
                id="submit-btn"
                style="padding: 0.75rem 2rem; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;"
                disabled
            >
                Submit
            </button>
            <button 
                type="button" 
                id="cancel-btn"
                style="padding: 0.75rem 2rem; background: #95a5a6; color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;"
            >
                Cancel
            </button>
        </div>
    </form>
</div>

<!-- Instructions Section -->
<div class="card" style="margin-top: 2rem;">
    <h3 style="margin-bottom: 1rem;">How to Use</h3>
    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
        Submit an analysis request to generate density, flow, and location reports for one or more events.
        All required files must exist in the <code>/data</code> directory.
    </p>
    <details style="margin-top: 1rem;">
        <summary style="cursor: pointer; color: #3498db; font-weight: 600;">View Example Request</summary>
        <pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; overflow-x: auto;"><code>{
  "description": "Saturday and Sunday race analysis",
  "segments_file": "segments.csv",
  "flow_file": "flow.csv",
  "locations_file": "locations.csv",
  "enableAudit": "y",
  "events": [
    {
      "name": "elite",
      "day": "sat",
      "start_time": 480,
      "event_duration_minutes": 45,
      "runners_file": "elite_runners.csv",
      "gpx_file": "elite.gpx"
    }
  ]
}</code></pre>
    </details>
</div>

<!-- Response View (hidden initially) -->
<div id="response-view" class="card" style="display: none; margin-top: 2rem;">
    <h3 style="margin-bottom: 1rem;">Analysis Confirmation</h3>
    <div style="margin-bottom: 1rem;">
        <strong>Run ID:</strong> <span id="response-run-id" style="font-family: monospace; color: #3498db;"></span>
    </div>
    <details open>
        <summary style="cursor: pointer; color: #3498db; font-weight: 600; margin-bottom: 0.5rem;">View analysis.json</summary>
        <pre id="analysis-json-display" style="background: #f8f9fa; padding: 1rem; border-radius: 4px; overflow-x: auto; max-height: 600px; overflow-y: auto; margin-top: 0.5rem;"><code></code></pre>
    </details>
</div>

{% endblock %}

{% block extra_styles %}
<style>
    /* Event row styling */
    .event-row {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        border: 1px solid #e0e0e0;
    }

    .event-row-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .event-row-number {
        font-weight: 600;
        color: #2c3e50;
    }

    .event-row-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-add-row, .btn-remove-row {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 4px;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-add-row {
        background: #2ecc71;
        color: white;
    }

    .btn-add-row:hover {
        background: #27ae60;
    }

    .btn-remove-row {
        background: #e74c3c;
        color: white;
    }

    .btn-remove-row:hover {
        background: #c0392b;
    }

    .event-fields {
        display: grid;
        grid-template-columns: 120px 150px 120px 120px 1fr 1fr;
        gap: 1rem;
        align-items: start;
    }

    .event-field {
        display: flex;
        flex-direction: column;
    }

    /* Narrow fields for Day, Start Time, and Duration */
    .event-field-narrow {
        max-width: 120px;
    }

    .event-field label {
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.875rem;
    }

    .event-field input, .event-field select {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .event-field .field-error {
        color: #e74c3c;
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }

    /* Loading state */
    #submit-btn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
    }

    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .event-fields {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
        .event-field-narrow {
            max-width: none;
        }
        .file-inputs-row {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }
    
    @media (max-width: 768px) {
        .event-fields {
            grid-template-columns: 1fr;
        }
        .file-inputs-row {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    let eventRowCount = 0;
    const DAYS = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

    // File lists cache
    let csvFiles = [];
    let gpxFiles = [];
    
    // Baseline state (Issue #676)
    let baselineState = {
        runId: null,
        baselineMetrics: null,
        selectedFiles: [],
        controlVariables: null,
        newBaselineMetrics: null
    };

    // Load files from API
    async function loadDataFiles() {
        try {
            // Load CSV files
            const csvResponse = await fetch('/api/data/files?extension=csv');
            if (csvResponse.ok) {
                const csvData = await csvResponse.json();
                csvFiles = csvData.files || [];
                
                // Populate segments, flow, locations dropdowns
                populateDropdown('segments_file', csvFiles);
                populateDropdown('flow_file', csvFiles);
                populateDropdown('locations_file', csvFiles);
            }
            
            // Load GPX files
            const gpxResponse = await fetch('/api/data/files?extension=gpx');
            if (gpxResponse.ok) {
                const gpxData = await gpxResponse.json();
                gpxFiles = gpxData.files || [];
            }
        } catch (error) {
            console.error('Error loading data files:', error);
        }
    }

    // Populate a dropdown with file options
    function populateDropdown(selectId, files) {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        // Clear existing options except the first (placeholder)
        while (select.options.length > 1) {
            select.remove(1);
        }
        
        // Add file options
        files.forEach(file => {
            const option = document.createElement('option');
            option.value = file;
            option.textContent = file;
            select.appendChild(option);
        });
    }

    // Populate runners and GPX dropdowns for an event row
    function populateEventFileDropdowns(rowId) {
        const runnersSelect = document.getElementById(`event-runners-file-${rowId}`);
        const gpxSelect = document.getElementById(`event-gpx-file-${rowId}`);
        
        if (runnersSelect) {
            // Clear existing options except the first
            while (runnersSelect.options.length > 1) {
                runnersSelect.remove(1);
            }
            // Add CSV files
            csvFiles.forEach(file => {
                const option = document.createElement('option');
                option.value = file;
                option.textContent = file;
                runnersSelect.appendChild(option);
            });
        }
        
        if (gpxSelect) {
            // Clear existing options except the first
            while (gpxSelect.options.length > 1) {
                gpxSelect.remove(1);
            }
            // Add GPX files
            gpxFiles.forEach(file => {
                const option = document.createElement('option');
                option.value = file;
                option.textContent = file;
                gpxSelect.appendChild(option);
            });
        }
    }

    // Initialize with one empty event row
    async function initForm() {
        // Load files first
        await loadDataFiles();
        addEventRow();
        updateSubmitButton();
    }

    // Add event row
    function addEventRow() {
        eventRowCount++;
        const container = document.getElementById('events-container');
        const row = document.createElement('div');
        row.className = 'event-row';
        row.id = `event-row-${eventRowCount}`;
        
        row.innerHTML = `
            <div class="event-row-header">
                <span class="event-row-number">Event ${eventRowCount}</span>
                <div class="event-row-actions">
                    <button type="button" class="btn-add-row" onclick="addEventRow()" title="Add another event">+</button>
                    <button type="button" class="btn-remove-row" onclick="removeEventRow(${eventRowCount})" title="Remove this event">-</button>
                </div>
            </div>
            <div class="event-fields">
                <div class="event-field event-field-narrow">
                    <label for="event-day-${eventRowCount}">Day <span style="color: #e74c3c;">*</span></label>
                    <select id="event-day-${eventRowCount}" name="events[${eventRowCount}][day]" required>
                        <option value="">Select day</option>
                        ${DAYS.map(day => `<option value="${day}">${day}</option>`).join('')}
                    </select>
                    <div class="field-error" id="event-day-${eventRowCount}-error" style="display: none;"></div>
                </div>
                <div class="event-field">
                    <label for="event-name-${eventRowCount}">Event <span style="color: #e74c3c;">*</span></label>
                    <input type="text" id="event-name-${eventRowCount}" name="events[${eventRowCount}][name]" required placeholder="elite" maxlength="8">
                    <div class="field-error" id="event-name-${eventRowCount}-error" style="display: none;"></div>
                </div>
                <div class="event-field event-field-narrow">
                    <label for="event-start-time-${eventRowCount}">Start Time <span style="color: #e74c3c;">*</span></label>
                    <input type="text" id="event-start-time-${eventRowCount}" name="events[${eventRowCount}][start_time]" required pattern="^([0-1][0-9]|2[0-3]):[0-5][0-9]$" placeholder="08:00" maxlength="5">
                    <small style="color: #7f8c8d; font-size: 0.75rem;">Time (05:00-20:00)</small>
                    <div class="field-error" id="event-start-time-${eventRowCount}-error" style="display: none;"></div>
                </div>
                <div class="event-field event-field-narrow">
                    <label for="event-duration-${eventRowCount}">Duration <span style="color: #e74c3c;">*</span></label>
                    <input type="number" id="event-duration-${eventRowCount}" name="events[${eventRowCount}][event_duration_minutes]" required placeholder="45" min="1" max="500">
                    <small style="color: #7f8c8d; font-size: 0.75rem;">Minutes (1-500)</small>
                    <div class="field-error" id="event-duration-${eventRowCount}-error" style="display: none;"></div>
                </div>
                <div class="event-field">
                    <label for="event-runners-file-${eventRowCount}">Runners File <span style="color: #e74c3c;">*</span></label>
                    <select id="event-runners-file-${eventRowCount}" name="events[${eventRowCount}][runners_file]" required>
                        <option value="">Select runners file...</option>
                    </select>
                    <div class="field-error" id="event-runners-file-${eventRowCount}-error" style="display: none;"></div>
                </div>
                <div class="event-field">
                    <label for="event-gpx-file-${eventRowCount}">GPX File <span style="color: #e74c3c;">*</span></label>
                    <select id="event-gpx-file-${eventRowCount}" name="events[${eventRowCount}][gpx_file]" required>
                        <option value="">Select GPX file...</option>
                    </select>
                    <div class="field-error" id="event-gpx-file-${eventRowCount}-error" style="display: none;"></div>
                </div>
            </div>
        `;
        
        container.appendChild(row);
        
        // Populate file dropdowns for this row
        populateEventFileDropdowns(eventRowCount);
        
        // Add event listeners for validation
        const inputs = row.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('input', updateSubmitButton);
            input.addEventListener('change', updateSubmitButton);
        });
        
        // Add time formatting for start_time input
        const startTimeInput = row.querySelector('input[name*="[start_time]"]');
        if (startTimeInput) {
            startTimeInput.addEventListener('input', function(e) {
                formatTimeInput(e.target);
            });
            startTimeInput.addEventListener('keydown', function(e) {
                // Allow backspace, delete, tab, escape, enter
                if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                    // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true) ||
                    // Allow home, end, left, right
                    (e.keyCode >= 35 && e.keyCode <= 39)) {
                    return;
                }
                // Ensure that it is a number and stop the keypress
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });
        }
        
        updateSubmitButton();
    }

    // Remove event row
    function removeEventRow(rowId) {
        const row = document.getElementById(`event-row-${rowId}`);
        if (row) {
            const container = document.getElementById('events-container');
            if (container.children.length > 1) {
                row.remove();
                updateSubmitButton();
            } else {
                alert('At least one event is required.');
            }
        }
    }

    // Convert hh:mm time string to minutes after midnight
    function timeToMinutes(timeStr) {
        if (!timeStr || !timeStr.includes(':')) {
            return null;
        }
        const [hours, minutes] = timeStr.split(':').map(Number);
        if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
            return null;
        }
        return hours * 60 + minutes;
    }

    // Convert minutes after midnight to hh:mm time string
    function minutesToTime(minutes) {
        if (isNaN(minutes)) {
            return '';
        }
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
    }
    
    // Format time input as user types (add colon automatically)
    function formatTimeInput(input) {
        let value = input.value.replace(/[^\d]/g, ''); // Remove non-digits
        if (value.length >= 2) {
            value = value.substring(0, 2) + ':' + value.substring(2, 4);
        }
        if (value.length > 5) {
            value = value.substring(0, 5);
        }
        input.value = value;
    }

    // Make functions global for onclick handlers
    window.addEventRow = addEventRow;
    window.removeEventRow = removeEventRow;

    // Update submit button state
    function updateSubmitButton() {
        const form = document.getElementById('analysis-form');
        const submitBtn = document.getElementById('submit-btn');
        
        // Check required fields
        const segmentsFile = document.getElementById('segments_file').value.trim();
        const flowFile = document.getElementById('flow_file').value.trim();
        const locationsFile = document.getElementById('locations_file').value.trim();
        
        // Check at least one event row with all required fields
        let hasValidEvent = false;
        const eventRows = document.querySelectorAll('.event-row');
        if (eventRows.length > 0) {
            eventRows.forEach(row => {
                const daySelect = row.querySelector('select[name*="[day]"]');
                const nameInput = row.querySelector('input[name*="[name]"]');
                const startTimeInput = row.querySelector('input[name*="[start_time]"]');
                const durationInput = row.querySelector('input[name*="[event_duration_minutes]"]');
                const runnersFileSelect = row.querySelector('select[name*="[runners_file]"]');
                const gpxFileSelect = row.querySelector('select[name*="[gpx_file]"]');
                
                if (!daySelect || !nameInput || !startTimeInput || !durationInput || !runnersFileSelect || !gpxFileSelect) {
                    return; // Skip if any required element is missing
                }
                
                const day = daySelect.value;
                const name = nameInput.value.trim();
                const startTime = startTimeInput.value.trim(); // Time input returns hh:mm format
                const duration = durationInput.value.trim();
                const runnersFile = runnersFileSelect.value.trim();
                const gpxFile = gpxFileSelect.value.trim();
                
                if (day && name && startTime && duration && runnersFile && gpxFile) {
                    hasValidEvent = true;
                }
            });
        }
        
        submitBtn.disabled = !(segmentsFile && flowFile && locationsFile && hasValidEvent);
    }

    // Clear all errors
    function clearErrors() {
        document.querySelectorAll('.field-error').forEach(el => {
            el.style.display = 'none';
            el.textContent = '';
        });
        document.getElementById('error-banner').style.display = 'none';
    }

    // Show field error
    function showFieldError(fieldId, message) {
        const errorEl = document.getElementById(`${fieldId}-error`);
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
    }

    // Validate form
    function validateForm() {
        clearErrors();
        let isValid = true;

        // Validate required analysis fields
        const segmentsFile = document.getElementById('segments_file').value.trim();
        const flowFile = document.getElementById('flow_file').value.trim();
        const locationsFile = document.getElementById('locations_file').value.trim();

        if (!segmentsFile) {
            showFieldError('segments_file', 'Segments file is required');
            isValid = false;
        }

        if (!flowFile) {
            showFieldError('flow_file', 'Flow file is required');
            isValid = false;
        }

        if (!locationsFile) {
            showFieldError('locations_file', 'Locations file is required');
            isValid = false;
        }

        // Validate events
        const eventRows = document.querySelectorAll('.event-row');
        if (eventRows.length === 0) {
            document.getElementById('events-error').textContent = 'At least one event is required';
            document.getElementById('events-error').style.display = 'block';
            isValid = false;
        }

        eventRows.forEach((row) => {
            const day = row.querySelector('select[name*="[day]"]')?.value;
            const name = row.querySelector('input[name*="[name]"]')?.value.trim();
            const startTime = row.querySelector('input[name*="[start_time]"]')?.value.trim();
            const duration = row.querySelector('input[name*="[event_duration_minutes]"]')?.value.trim();
            const runnersFile = row.querySelector('select[name*="[runners_file]"]')?.value.trim();
            const gpxFile = row.querySelector('select[name*="[gpx_file]"]')?.value.trim();

            // Extract row number from row ID (e.g., "event-row-1" -> 1)
            const rowId = row.id;
            const rowNum = rowId ? parseInt(rowId.replace('event-row-', '')) : 0;

            if (!day) {
                showFieldError(`event-day-${rowNum}`, 'Day is required');
                isValid = false;
            }
            if (!name) {
                showFieldError(`event-name-${rowNum}`, 'Event name is required');
                isValid = false;
            }
            if (!startTime) {
                showFieldError(`event-start-time-${rowNum}`, 'Start time is required');
                isValid = false;
            } else {
                const startTimeMinutes = timeToMinutes(startTime);
                if (startTimeMinutes === null) {
                    showFieldError(`event-start-time-${rowNum}`, 'Start time must be in HH:MM format');
                    isValid = false;
                } else if (startTimeMinutes < 300 || startTimeMinutes > 1200) {
                    showFieldError(`event-start-time-${rowNum}`, 'Start time must be between 05:00 and 20:00');
                    isValid = false;
                }
            }
            if (!duration) {
                showFieldError(`event-duration-${rowNum}`, 'Duration is required');
                isValid = false;
            } else {
                const durationNum = parseInt(duration);
                if (durationNum < 1 || durationNum > 500) {
                    showFieldError(`event-duration-${rowNum}`, 'Duration must be between 1 and 500 minutes');
                    isValid = false;
                }
            }
            if (!runnersFile) {
                showFieldError(`event-runners-file-${rowNum}`, 'Runners file is required');
                isValid = false;
            }
            if (!gpxFile) {
                showFieldError(`event-gpx-file-${rowNum}`, 'GPX file is required');
                isValid = false;
            }
        });

        return isValid;
    }

    // Build request payload
    function buildPayload() {
        const description = document.getElementById('description').value.trim();
        const segmentsFile = document.getElementById('segments_file').value.trim();
        const flowFile = document.getElementById('flow_file').value.trim();
        const locationsFile = document.getElementById('locations_file').value.trim();
        const enableAudit = document.getElementById('enable_audit').value;

        const events = [];
        const eventRows = document.querySelectorAll('.event-row');
        eventRows.forEach(row => {
            const day = row.querySelector('select[name*="[day]"]')?.value;
            const name = row.querySelector('input[name*="[name]"]')?.value.trim();
            const startTimeStr = row.querySelector('input[name*="[start_time]"]')?.value.trim() || '';
            const startTime = timeToMinutes(startTimeStr) || 0; // Convert hh:mm to minutes
            const duration = parseInt(row.querySelector('input[name*="[event_duration_minutes]"]')?.value.trim() || '0');
            const runnersFile = row.querySelector('select[name*="[runners_file]"]')?.value.trim();
            const gpxFile = row.querySelector('select[name*="[gpx_file]"]')?.value.trim();

            events.push({
                name: name,
                day: day,
                start_time: startTime,
                event_duration_minutes: duration,
                runners_file: runnersFile,
                gpx_file: gpxFile
            });
        });

        const payload = {
            segments_file: segmentsFile,
            flow_file: flowFile,
            locations_file: locationsFile,
            events: events
        };

        if (description) {
            payload.description = description;
        }

        // Issue #635: Add enableAudit to payload (always include, default "n")
        payload.enableAudit = enableAudit || "n";

        return payload;
    }

    // Submit form
    async function submitForm(event) {
        event.preventDefault();
        
        if (!validateForm()) {
            return;
        }

        const submitBtn = document.getElementById('submit-btn');
        const form = document.getElementById('analysis-form');
        
        // Disable form and show loading
        submitBtn.disabled = true;
        form.classList.add('loading');
        submitBtn.textContent = 'Submitting...';
        clearErrors();

        const payload = buildPayload();

        try {
            const response = await fetch('/runflow/v2/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (!response.ok) {
                // Handle error response
                const errorBanner = document.getElementById('error-banner');
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = data.error || `HTTP ${response.status}: ${response.statusText}`;
                errorBanner.style.display = 'block';
                errorBanner.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                // Success - show confirmation and fetch analysis.json
                const successBanner = document.getElementById('success-banner');
                const successMessage = document.getElementById('success-message');
                successMessage.textContent = `Analysis submitted successfully. Run ID: ${data.run_id}. Estimated completion: 3-4 minutes.`;
                successBanner.style.display = 'block';
                successBanner.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Fetch and display analysis.json
                await displayAnalysisJson(data.run_id);
            }
        } catch (error) {
            const errorBanner = document.getElementById('error-banner');
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = `Error submitting analysis: ${error.message}`;
            errorBanner.style.display = 'block';
            errorBanner.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } finally {
            // Re-enable form
            submitBtn.disabled = false;
            form.classList.remove('loading');
            submitBtn.textContent = 'Submit';
        }
    }

    // Fetch and display analysis.json
    async function displayAnalysisJson(runId) {
        try {
            // Construct path to analysis.json
            const response = await fetch(`/api/analysis/${runId}/config`);
            
            if (!response.ok) {
                throw new Error(`Failed to fetch analysis.json: ${response.statusText}`);
            }

            const analysisJson = await response.json();
            
            // Display run_id
            document.getElementById('response-run-id').textContent = runId;
            
            // Pretty-print JSON
            const jsonDisplay = document.getElementById('analysis-json-display');
            jsonDisplay.querySelector('code').textContent = JSON.stringify(analysisJson, null, 2);
            
            // Show response view
            document.getElementById('response-view').style.display = 'block';
            document.getElementById('response-view').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } catch (error) {
            console.error('Error fetching analysis.json:', error);
            // Still show success, but note that analysis.json couldn't be loaded
            const errorBanner = document.getElementById('error-banner');
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = `Analysis submitted successfully, but could not load analysis.json: ${error.message}`;
            errorBanner.style.display = 'block';
        }
    }

    // Cancel button
    document.getElementById('cancel-btn').addEventListener('click', function() {
        if (confirm('Clear all form data?')) {
            document.getElementById('analysis-form').reset();
            document.getElementById('events-container').innerHTML = '';
            eventRowCount = 0;
            initForm();
            clearErrors();
            document.getElementById('success-banner').style.display = 'none';
            document.getElementById('response-view').style.display = 'none';
        }
    });

    // Form submit handler (for Enter key submissions)
    document.getElementById('analysis-form').addEventListener('submit', function(event) {
        event.preventDefault();
        if (!document.getElementById('submit-btn').disabled) {
            submitForm(event);
        }
    });

    // Submit button click handler (manual submission since button type is now 'button')
    document.getElementById('submit-btn').addEventListener('click', function(event) {
        event.preventDefault();
        if (!this.disabled) {
            submitForm(event);
        }
    });

    // ===== Baseline Utility Functions (Issue #676) =====
    
    // Load runner files for baseline selection
    async function loadRunnerFilesForBaseline() {
        try {
            const response = await fetch('/api/data/files?extension=csv');
            if (response.ok) {
                const data = await response.json();
                const runnerFiles = (data.files || []).filter(f => f.endsWith('_runners.csv'));
                renderBaselineFileSelection(runnerFiles);
            }
        } catch (error) {
            console.error('Error loading runner files:', error);
        }
    }
    
    // Render file selection checkboxes
    function renderBaselineFileSelection(files) {
        const container = document.getElementById('baseline-file-selection');
        if (!container) return;
        container.innerHTML = '';
        
        files.forEach(file => {
            const label = document.createElement('label');
            label.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; cursor: pointer;';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = file;
            checkbox.addEventListener('change', updateBaselineCalculateButton);
            
            const span = document.createElement('span');
            span.textContent = file;
            
            label.appendChild(checkbox);
            label.appendChild(span);
            container.appendChild(label);
        });
    }
    
    // Update Calculate Baseline button state
    function updateBaselineCalculateButton() {
        const checkboxes = document.querySelectorAll('#baseline-file-selection input[type="checkbox"]');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        const btn = document.getElementById('baseline-calculate-btn');
        if (btn) {
            btn.disabled = checked.length === 0;
        }
    }
    
    // Calculate baseline metrics
    async function calculateBaseline() {
        const checkboxes = document.querySelectorAll('#baseline-file-selection input[type="checkbox"]');
        const selectedFiles = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        
        if (selectedFiles.length === 0) {
            showBaselineError('Please select at least one runner file');
            return;
        }
        
        const btn = document.getElementById('baseline-calculate-btn');
        btn.disabled = true;
        btn.textContent = 'Calculating...';
        clearBaselineErrors();
        
        try {
            const response = await fetch('/api/baseline/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ selected_files: selectedFiles })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || 'Failed to calculate baseline');
            }
            
            // Store baseline state
            baselineState.runId = data.run_id;
            baselineState.baselineMetrics = data.baseline_metrics;
            baselineState.selectedFiles = selectedFiles;
            
            // Render baseline metrics table
            renderBaselineMetricsTable(data.baseline_metrics);
            
            // Show step 2 and 3
            document.getElementById('baseline-step2').style.display = 'block';
            document.getElementById('baseline-step3').style.display = 'block';
            
            // Render control variables table
            renderControlVariablesTable(data.baseline_metrics);
            
        } catch (error) {
            showBaselineError(error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Calculate Baseline';
        }
    }
    
    // Render baseline metrics table
    function renderBaselineMetricsTable(metrics) {
        const container = document.getElementById('baseline-metrics-table');
        if (!container) return;
        const events = Object.keys(metrics);
        
        if (events.length === 0) {
            container.innerHTML = '<p>No baseline metrics available</p>';
            return;
        }
        
        let html = '<table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;"><thead><tr>';
        html += '<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: left;">Metric</th>';
        events.forEach(event => {
            html += `<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: center;">${event}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        // Participants
        html += '<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">Participants</td>';
        events.forEach(event => {
            html += `<td style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">${metrics[event].base_participants}</td>`;
        });
        html += '</tr>';
        
        // Percentiles
        const percentiles = ['P00 (Lead)', 'P05', 'P25', 'P50 (Median)', 'P75', 'P95', 'P100 (Last)'];
        const percentileKeys = ['base_p00', 'base_p05', 'base_p25', 'base_p50', 'base_p75', 'base_p95', 'base_p100'];
        
        percentiles.forEach((label, idx) => {
            html += `<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">${label}</td>`;
            events.forEach(event => {
                const value = metrics[event][percentileKeys[idx]];
                html += `<td style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">${value.toFixed(2)}</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // Render control variables input table
    function renderControlVariablesTable(metrics) {
        const container = document.getElementById('baseline-control-variables-table');
        if (!container) return;
        const events = Object.keys(metrics);
        
        if (events.length === 0) {
            container.innerHTML = '<p>No events available</p>';
            return;
        }
        
        let html = '<table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;"><thead><tr>';
        html += '<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: left;">Variable</th>';
        events.forEach(event => {
            html += `<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: center;">${event}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        // Participants change
        html += '<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">Participants %</td>';
        events.forEach(event => {
            html += `<td style="padding: 0.5rem; border: 1px solid #ddd;">
                <input type="number" id="chg_participants_${event}" step="0.01" value="0" 
                       style="width: 100%; padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
            </td>`;
        });
        html += '</tr>';
        
        // Percentile changes
        const percentileLabels = ['P00 %', 'P05 %', 'P25 %', 'P50 %', 'P75 %', 'P95 %', 'P100 %'];
        const percentileKeys = ['chg_p00', 'chg_p05', 'chg_p25', 'chg_p50', 'chg_p75', 'chg_p95', 'chg_p100'];
        
        percentileLabels.forEach((label, idx) => {
            html += `<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">${label}</td>`;
            events.forEach(event => {
                html += `<td style="padding: 0.5rem; border: 1px solid #ddd;">
                    <input type="number" id="${percentileKeys[idx]}_${event}" step="0.01" value="0" 
                           style="width: 100%; padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
                </td>`;
            });
            html += '</tr>';
        });
        
        // Cut-off time (optional)
        html += '<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">Cut-off (hh:mm)</td>';
        events.forEach(event => {
            html += `<td style="padding: 0.5rem; border: 1px solid #ddd;">
                <input type="text" id="cutoff_${event}" placeholder="06:00" pattern="^([0-1][0-9]|2[0-3]):[0-5][0-9]$"
                       style="width: 100%; padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
            </td>`;
        });
        html += '</tr>';
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // Calculate new baseline
    async function calculateNewBaseline() {
        if (!baselineState.runId || !baselineState.baselineMetrics) {
            showBaselineError('Please calculate baseline first');
            return;
        }
        
        const events = Object.keys(baselineState.baselineMetrics);
        const controlVariables = {};
        
        // Collect control variables from inputs
        events.forEach(event => {
            controlVariables[event] = {
                chg_participants: parseFloat(document.getElementById(`chg_participants_${event}`).value) || 0,
                chg_p00: parseFloat(document.getElementById(`chg_p00_${event}`).value) || 0,
                chg_p05: parseFloat(document.getElementById(`chg_p05_${event}`).value) || 0,
                chg_p25: parseFloat(document.getElementById(`chg_p25_${event}`).value) || 0,
                chg_p50: parseFloat(document.getElementById(`chg_p50_${event}`).value) || 0,
                chg_p75: parseFloat(document.getElementById(`chg_p75_${event}`).value) || 0,
                chg_p95: parseFloat(document.getElementById(`chg_p95_${event}`).value) || 0,
                chg_p100: parseFloat(document.getElementById(`chg_p100_${event}`).value) || 0
            };
            
            // Optional cut-off time
            const cutoffInput = document.getElementById(`cutoff_${event}`);
            if (cutoffInput && cutoffInput.value.trim()) {
                controlVariables[event].cutoff_mins = cutoffInput.value.trim();
            }
        });
        
        const btn = document.getElementById('baseline-calculate-new-btn');
        btn.disabled = true;
        btn.textContent = 'Calculating...';
        clearBaselineErrors();
        
        try {
            const response = await fetch('/api/baseline/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    baseline_run_id: baselineState.runId,
                    control_variables: controlVariables
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || 'Failed to generate new baseline');
            }
            
            // Store new baseline metrics
            baselineState.controlVariables = controlVariables;
            baselineState.newBaselineMetrics = data.updated_baseline_json.new_baseline_metrics;
            
            // Render new baseline metrics table
            renderNewBaselineMetricsTable(data.updated_baseline_json.new_baseline_metrics);
            
            // Show step 4
            document.getElementById('baseline-step4').style.display = 'block';
            
        } catch (error) {
            showBaselineError(error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Calculate New Baseline';
        }
    }
    
    // Render new baseline metrics table
    function renderNewBaselineMetricsTable(newMetrics) {
        const container = document.getElementById('baseline-new-metrics-table');
        if (!container) return;
        const events = Object.keys(newMetrics);
        
        if (events.length === 0) {
            container.innerHTML = '<p>No new baseline metrics available</p>';
            return;
        }
        
        let html = '<table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;"><thead><tr>';
        html += '<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: left;">Metric</th>';
        events.forEach(event => {
            html += `<th style="padding: 0.5rem; border: 1px solid #ddd; background: #f8f9fa; text-align: center;">${event}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        // Participants
        html += '<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">Participants (new)</td>';
        events.forEach(event => {
            html += `<td style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">${newMetrics[event].new_participants}</td>`;
        });
        html += '</tr>';
        
        // Percentiles
        const percentiles = ['P00 (Lead)', 'P05', 'P25', 'P50 (Median)', 'P75', 'P95', 'P100 (Last)'];
        const percentileKeys = ['new_p00', 'new_p05', 'new_p25', 'new_p50', 'new_p75', 'new_p95', 'new_p100'];
        
        percentiles.forEach((label, idx) => {
            html += `<tr><td style="padding: 0.5rem; border: 1px solid #ddd; font-weight: 600;">${label}</td>`;
            events.forEach(event => {
                const value = newMetrics[event][percentileKeys[idx]];
                html += `<td style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">${value.toFixed(2)}</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    // Create new files
    async function createNewFiles() {
        if (!baselineState.runId) {
            showBaselineError('Please calculate baseline and new baseline first');
            return;
        }
        
        // Files are already created by calculateNewBaseline endpoint
        // Just show success message
        showBaselineSuccess(`Files created successfully! Baseline run ID: ${baselineState.runId}`);
        
        // Optionally, show file list
        try {
            const filesResponse = await fetch(`/api/baseline/files?run_id=${baselineState.runId}`);
            if (filesResponse.ok) {
                const filesData = await filesResponse.json();
                console.log('Generated files:', filesData.files);
            }
        } catch (error) {
            console.error('Error fetching file list:', error);
        }
    }
    
    // Clear baseline state
    function clearBaseline() {
        baselineState = {
            runId: null,
            baselineMetrics: null,
            selectedFiles: [],
            controlVariables: null,
            newBaselineMetrics: null
        };
        
        // Reset UI
        document.getElementById('baseline-step2').style.display = 'none';
        document.getElementById('baseline-step3').style.display = 'none';
        document.getElementById('baseline-step4').style.display = 'none';
        
        // Uncheck all checkboxes
        document.querySelectorAll('#baseline-file-selection input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        
        updateBaselineCalculateButton();
        clearBaselineErrors();
    }
    
    // Show baseline error
    function showBaselineError(message) {
        const errorEl = document.getElementById('baseline-file-selection-error');
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
    }
    
    // Show baseline success
    function showBaselineSuccess(message) {
        const successBanner = document.getElementById('success-banner');
        const successMessage = document.getElementById('success-message');
        if (successBanner && successMessage) {
            successMessage.textContent = message;
            successBanner.style.display = 'block';
            successBanner.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
    
    // Clear baseline errors
    function clearBaselineErrors() {
        const errorEl = document.getElementById('baseline-file-selection-error');
        if (errorEl) {
            errorEl.style.display = 'none';
        }
    }

    // Initialize form on page load
    initForm();
    
    // Attach event listeners for baseline (Issue #676)
    document.addEventListener('DOMContentLoaded', function() {
        const calcBtn = document.getElementById('baseline-calculate-btn');
        const calcNewBtn = document.getElementById('baseline-calculate-new-btn');
        const createBtn = document.getElementById('baseline-create-files-btn');
        const clearBtn = document.getElementById('baseline-clear-btn');
        
        if (calcBtn) calcBtn.addEventListener('click', calculateBaseline);
        if (calcNewBtn) calcNewBtn.addEventListener('click', calculateNewBaseline);
        if (createBtn) createBtn.addEventListener('click', createNewFiles);
        if (clearBtn) clearBtn.addEventListener('click', clearBaseline);
        
        // Load runner files for baseline
        loadRunnerFilesForBaseline();
    });
})();
</script>
{% endblock %}

