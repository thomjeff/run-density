# Work Plan - September 18, 2025

## **Session Overview**
- **Date**: September 18, 2025  
- **Focus**: Resolve Cloud Run environment variable issue and complete Issue #198 deployment  
- **Priority**: Fix environment variable reading problem blocking bin dataset deployment  
- **Milestone**: Complete Issue #198 (bin dataset Cloud Run deployment)  
- **Dependencies**: Issue #217 fix is complete and ready for deployment

---

## ** INSTRUCTIONS FOR CURSOR **
1. **CRITICAL**: Focus solely on Issues #198 and #217 - no other issues until these are complete
2. **Environment Variable Issue**: Resolve why `ENABLE_BIN_DATASET=true` in Cloud Run config but application reads `false`
3. **Deployment Validation**: Get working bin dataset generation deployed and validated on Cloud Run
4. **Production Testing**: Confirm bin artifacts are generated in Cloud Storage (~1.5MB files)
5. **Follow ChatGPT Runbook**: Use `@CloudRun_Deploy_Runbook_Issue198_217.md` systematically
6. **Pre-task Safeguards**: Always activate virtual environment and use automated E2E testing

---

## **🚨 CRITICAL BLOCKING ISSUE**

### **Environment Variable Reading Problem**
- **Current State**: `ENABLE_BIN_DATASET=true` set in Cloud Run but application logs show `ENABLE_BIN_DATASET=false`
- **Impact**: Working local fix cannot be deployed or tested on Cloud Run
- **Evidence**: 
  ```bash
  # Cloud Run config shows:
  - name: ENABLE_BIN_DATASET
    value: 'true'
  
  # Application logs show:
  📦 Bin dataset generation disabled (ENABLE_BIN_DATASET=false)
  ```

### **Investigation Required**
1. **Code Analysis**: Verify `os.getenv()` usage in `density_report.py`
2. **Environment Debugging**: Add diagnostic logging to trace environment variable reading
3. **Cloud Run Configuration**: Verify environment variable is actually being passed to container
4. **Application Startup**: Check if environment variables are being read at startup vs runtime

---

## **📋 PRIORITY TASKS (IN ORDER)**

### **1. Environment Variable Debugging - CRITICAL**
- **Goal**: Resolve why Cloud Run environment variable is not being read by application
- **Actions**:
  - Add diagnostic logging to `density_report.py` to trace environment variable reading
  - Verify `os.getenv('ENABLE_BIN_DATASET')` is working correctly
  - Check for any environment variable caching or startup issues
  - Test with simple environment variable to isolate the problem

### **2. Deploy Working Fix to Cloud Run**
- **Goal**: Get Issue #217 fix deployed and working on Cloud Run
- **Actions**:
  - Follow ChatGPT runbook systematically (`@CloudRun_Deploy_Runbook_Issue198_217.md`)
  - Deploy with `ENABLE_BIN_DATASET=true` and verify it's being read
  - Test bin dataset generation on Cloud Run
  - Monitor Cloud Run logs for successful bin generation

### **3. Validate Production Bin Generation**
- **Goal**: Confirm bin artifacts are generated in Cloud Storage
- **Actions**:
  - Call `/api/density-report` endpoint on Cloud Run
  - Verify bin dataset generation logs show success
  - Check Cloud Storage for bin artifacts (~1.5MB GeoJSON files)
  - Validate bin data contains real density/flow values (not 0.0)

### **4. Complete Issue #198**
- **Goal**: Finish Cloud Run deployment and performance validation
- **Actions**:
  - Run comprehensive Cloud Run testing
  - Validate performance meets budgets (<120s generation time)
  - Confirm bin artifacts integrate with existing map/report workflows
  - Update Issue #198 with deployment success

---

## **🔧 TECHNICAL APPROACH**

### **Environment Variable Investigation**
```python
# Add to density_report.py for debugging
import os
print(f"🔍 Environment variables:")
print(f"  ENABLE_BIN_DATASET: {os.getenv('ENABLE_BIN_DATASET')}")
print(f"  All env vars with BIN: {[k for k in os.environ.keys() if 'BIN' in k]}")
print(f"  All env vars: {dict(os.environ)}")
```

### **Deployment Strategy**
1. **Diagnostic Deploy**: Add environment variable debugging to current code
2. **Test Deploy**: Deploy with debugging and verify environment variable reading
3. **Production Deploy**: Deploy working fix once environment variable issue resolved
4. **Validation**: Confirm bin artifacts generated and accessible

### **ChatGPT Runbook Execution**
- **Section 2**: Staging Deploy with feature flag OFF
- **Section 3**: Canary testing with feature flag ON
- **Section 4**: Telemetry validation in logs
- **Section 5**: Artifact check in Cloud Storage
- **Section 6**: Reconciliation gate validation

---

## **⏰ TIME ALLOCATION STRATEGY**

### **Morning Session (Environment Variable Fix)**
- **Focus**: Resolve environment variable reading issue
- **Goal**: Understand why Cloud Run config doesn't match application reading
- **Deliverables**: Working environment variable reading on Cloud Run

### **Afternoon Session (Deployment & Validation)**
- **Focus**: Deploy Issue #217 fix and validate on Cloud Run
- **Goal**: Confirm bin artifacts generated in Cloud Storage
- **Deliverables**: Working bin dataset generation on production

### **Evening Session (Issue Completion)**
- **Focus**: Complete Issue #198 and document results
- **Goal**: Full Cloud Run deployment validation and issue closure
- **Deliverables**: Issues #198 and #217 completed

---

## **🚀 SUCCESS METRICS**

### **Critical Success Criteria**
- ✅ Environment variable `ENABLE_BIN_DATASET=true` properly read by application
- ✅ Bin dataset generation working on Cloud Run
- ✅ Bin artifacts generated in Cloud Storage (~1.5MB files)
- ✅ Real density/flow values in generated artifacts (not 0.0)
- ✅ Performance meets budgets (<120s generation time)
- ✅ Issue #198 and #217 marked as complete

### **Quality Assurance**
- ✅ Cloud Run logs show successful bin generation
- ✅ Bin artifacts accessible via Cloud Storage
- ✅ End-to-end testing passes on Cloud Run
- ✅ No environment variable reading errors

---

## **📁 EXPECTED FILE MODIFICATIONS**

### **Debugging Files**
- `app/density_report.py` - Add environment variable diagnostic logging
- `app/main.py` - Add startup environment variable logging

### **Deployment Files**
- Cloud Run service configuration updates
- Environment variable verification scripts
- Deployment validation scripts

### **Documentation Files**
- Issue #198 completion update
- Issue #217 final status update
- Deployment validation results

---

## **🎯 ACCEPTANCE CRITERIA**

### **Environment Variable Fix**
- [ ] Application logs show `ENABLE_BIN_DATASET=true` when set in Cloud Run
- [ ] No environment variable reading errors in logs
- [ ] Diagnostic logging confirms proper environment variable access

### **Bin Dataset Deployment**
- [ ] Bin dataset generation enabled on Cloud Run
- [ ] Cloud Run logs show successful bin generation
- [ ] Bin artifacts generated in Cloud Storage
- [ ] Real density/flow values in generated artifacts

### **Issue Completion**
- [ ] Issue #198 marked as complete with deployment validation
- [ ] Issue #217 marked as complete with production confirmation
- [ ] All acceptance criteria met for both issues

---

## **🚨 RISK MITIGATION**

### **Environment Variable Issues**
- **Risk**: Environment variable still not being read correctly
- **Mitigation**: Add comprehensive diagnostic logging and test with simple variables first

### **Deployment Failures**
- **Risk**: Bin dataset generation fails on Cloud Run
- **Mitigation**: Follow ChatGPT runbook systematically with staging deployment first

### **Performance Issues**
- **Risk**: Bin generation exceeds time budgets on Cloud Run
- **Mitigation**: Use performance optimization (coarsening, hotspot preservation) already implemented

---

## **📊 VALIDATION CHECKLIST**

### **Environment Variable Validation**
- [ ] Cloud Run config shows `ENABLE_BIN_DATASET=true`
- [ ] Application logs show `ENABLE_BIN_DATASET=true`
- [ ] No environment variable reading errors
- [ ] Diagnostic logging confirms proper access

### **Bin Generation Validation**
- [ ] Cloud Run logs show bin generation enabled
- [ ] Bin generation completes successfully
- [ ] Performance within budgets (<120s)
- [ ] No timeout or memory errors

### **Artifact Validation**
- [ ] Bin artifacts generated in Cloud Storage
- [ ] File sizes approximately 1.5MB (GeoJSON)
- [ ] Real density/flow values (not 0.0)
- [ ] Proper schema compliance

---

**Prepared by**: Jeff and AI Assistant  
**Date**: September 17, 2025  
**Next Review**: End of day status update  
**Priority**: Complete Issues #198 and #217 - no other work until these are done

**Note**: This work plan focuses exclusively on resolving the Cloud Run environment variable issue and completing the bin dataset deployment. All other issues are deferred until Issues #198 and #217 are fully complete and validated in production.



