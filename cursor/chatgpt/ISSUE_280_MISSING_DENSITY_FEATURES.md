# Issue #280 - Missing Density Visualization Features

**Created**: 2025-10-19  
**GitHub Issue**: https://github.com/thomjeff/run-density/issues/280  
**Parent Issue**: #279 (RF-FE-002 - New Multi-Page Web UI)  
**Project**: runflow  
**Label**: enhancement  
**Status**: Open

---

## Problem Identified

During review of the RF-FE-002 Step 8 implementation, identified that ChatGPT's technical architecture decision document specified **two critical visualization features** that were **not delivered**:

1. **Density Heatmaps (PNG files)** - Visual time-series density heatmaps for each segment
2. **Bin-Level Details Table** - Detailed CSV export with bin-level temporal metrics

---

## What Was Missing

### 1. Heatmap Generation ❌

**Specified In**: `cursor/chatgpt/TECHNICAL_ARCHITECTURE_DECISION_RF-FE-002.md`

```
| density.html | Segment table + heatmap PNG + bin-level table |
| **Density** → heatmap PNGs or placeholders; bin-level table if CSV exists.
```

**Should Have Been**:
- `artifacts/<run_id>/ui/heatmaps/<seg_id>.png` files generated
- PNG heatmaps showing density over time for each segment
- Generated by `analytics/export_frontend_artifacts.py`
- Displayed in density detail panel when user clicks segment

**Current State**:
- Empty placeholder: "No heatmap data available for this segment"
- No PNG generation in analytics exporter
- UI code ready but no data to display

### 2. Bin-Level Details ❌

**Specified In**: `cursor/chatgpt/TECHNICAL_ARCHITECTURE_DECISION_RF-FE-002.md`

```
| **Local** | FS path `DATA_ROOT` | `segments.geojson`, `segment_metrics.json`, `flags.json`, `meta.json`, bin_details/*.csv, heatmaps/*.png |
```

**Should Have Been**:
- `artifacts/<run_id>/ui/bin_details/<seg_id>.csv` files generated
- CSV with columns: time_start, time_end, km_start, km_end, density, rate, utilization, los, flagged
- Generated by `analytics/export_frontend_artifacts.py`
- Rendered as table in density detail panel

**Current State**:
- Empty placeholder: "No bin-level data available"
- No CSV generation in analytics exporter
- No bin-level table rendering in UI

### 3. Storage Helpers ❌

**Specified In**: `cursor/chatgpt/STEP3_COMPLETION_SUMMARY.md`

```python
load_bin_details_csv(storage, "A1")  # Load bin_details/A1.csv
heatmap_exists(storage, "A1")        # Check heatmaps/A1.png
```

**Should Have Been**:
- Helper functions in `app/storage.py`
- Support for loading heatmap URLs
- Support for loading bin_details CSV data

**Current State**:
- Functions mentioned but never implemented
- No support in storage adapter

---

## Impact Assessment

### User Experience Impact
- ❌ **No visual heatmaps** - Users cannot see density patterns over time
- ❌ **No bin-level drill-down** - Users cannot analyze detailed temporal bins
- ❌ **Incomplete operational intelligence** - Missing critical visualization tools
- ❌ **Mismatch with Canva v2 mocks** - Planned features not delivered

### Technical Debt Impact
- ❌ **Architecture decision document doesn't match implementation**
- ❌ **Partial implementation creates confusion** (placeholders vs. unimplemented)
- ❌ **Step 3 documentation references non-existent functions**
- ❌ **Step 8 marked "complete" but missing major features**

---

## What Needs to Be Done

### Phase 1: Analytics Export (Priority: High)

**File**: `analytics/export_frontend_artifacts.py`

1. **Add Heatmap Generation**:
   ```python
   def generate_heatmaps(reports_root: Path, run_id: str, output_dir: Path):
       """Generate PNG heatmaps for each segment from bins.parquet."""
       # Load bins.parquet
       # Group by segment_id
       # For each segment:
       #   - Create matplotlib time-series plot
       #   - X-axis: time (bins)
       #   - Y-axis: density (p/m²)
       #   - Color bands by LOS thresholds
       #   - Save as PNG: output_dir/heatmaps/<seg_id>.png
   ```

2. **Add Bin-Level CSV Export**:
   ```python
   def generate_bin_details_csv(reports_root: Path, run_id: str, output_dir: Path):
       """Export detailed bin-level metrics to CSV files."""
       # Load bins.parquet
       # Group by segment_id
       # For each segment:
       #   - Export CSV with all bin metrics
       #   - Save as: output_dir/bin_details/<seg_id>.csv
   ```

3. **Wire Into Exporter**:
   ```python
   def export_ui_artifacts(reports_root: Path, run_id: str):
       # ... existing code ...
       generate_heatmaps(reports_root, run_id, ui_dir)
       generate_bin_details_csv(reports_root, run_id, ui_dir)
   ```

### Phase 2: Storage & API (Priority: Medium)

**File**: `app/storage.py`

```python
def heatmap_exists(storage: Storage, seg_id: str) -> bool:
    """Check if heatmap PNG exists for segment."""
    return storage.exists(f"heatmaps/{seg_id}.png")

def get_heatmap_url(storage: Storage, seg_id: str) -> Optional[str]:
    """Get heatmap URL or None if doesn't exist."""
    if heatmap_exists(storage, seg_id):
        return f"/artifacts/{load_latest_run_id(storage)}/ui/heatmaps/{seg_id}.png"
    return None

def load_bin_details_csv(storage: Storage, seg_id: str) -> Optional[List[Dict]]:
    """Load bin-level details from CSV."""
    path = f"bin_details/{seg_id}.csv"
    if not storage.exists(path):
        return None
    # Read CSV and return as list of dicts
```

**File**: `app/routes/api_density.py`

```python
@router.get("/api/density/segment/{seg_id}")
async def get_density_segment_detail(seg_id: str):
    # ... existing code ...
    
    # Add heatmap URL
    heatmap_url = get_heatmap_url(storage, seg_id)
    
    # Add bin details
    bin_details = load_bin_details_csv(storage, seg_id)
    
    return {
        # ... existing fields ...
        "heatmap_url": heatmap_url,
        "bin_details": bin_details or []
    }
```

### Phase 3: UI Enhancement (Priority: Low - Mostly Done)

**File**: `templates/pages/density.html`

The UI already handles heatmap display. Only need to add bin-level table rendering:

```javascript
function renderSegmentDetail(detail) {
    // ... existing code for heatmap (already implemented) ...
    
    // Render bin-level table
    if (detail.bin_details && detail.bin_details.length > 0) {
        renderBinDetailsTable(detail.bin_details);
    } else {
        // Show empty state (already implemented)
    }
}

function renderBinDetailsTable(bins) {
    const container = document.getElementById('bin-table-content');
    // Build HTML table with all bin metrics
    // Columns: Time, Location (km), Density, Rate, Utilization, LOS, Flagged
}
```

---

## Testing Requirements

### Unit Tests
- [ ] Test heatmap generation produces valid PNG files
- [ ] Test bin_details CSV export has correct schema
- [ ] Test storage helpers return correct data

### Integration Tests
- [ ] E2E run produces heatmaps for all segments
- [ ] E2E run produces bin_details CSVs for all segments
- [ ] API returns heatmap_url and bin_details correctly

### UI Tests
- [ ] Density page displays heatmap when available
- [ ] Density page displays bin-level table when available
- [ ] Empty states shown when data missing

---

## Dependencies

### Analytics Dependencies (OK - Not Web Runtime)
- `matplotlib` for heatmap PNG generation
- Already available in analytics environment
- **Not needed in web runtime** (serves pre-generated PNGs)

### No New Web Runtime Dependencies
- ✅ Maintains lean web runtime per architecture
- ✅ All visualization happens offline during analytics
- ✅ Web runtime only serves static files

---

## Acceptance Criteria

### Definition of Done

- [ ] **Heatmaps Generated**: `artifacts/<run_id>/ui/heatmaps/*.png` files exist
- [ ] **Bin Details Exported**: `artifacts/<run_id>/ui/bin_details/*.csv` files exist
- [ ] **Storage Helpers Implemented**: `heatmap_exists()`, `get_heatmap_url()`, `load_bin_details_csv()`
- [ ] **API Enhanced**: `/api/density/segment/<seg_id>` returns heatmap_url and bin_details
- [ ] **UI Renders Data**: Density page shows heatmaps and bin-level tables
- [ ] **Tests Pass**: All unit, integration, and UI tests green
- [ ] **Documentation Updated**: Step 8 completion summary reflects new features

---

## Priority Justification

**Medium-High Priority**

While the density table works and provides value, these visualization features:
- Were explicitly specified in the architecture decision
- Provide significant operational intelligence for race directors
- Are expected by users based on Canva v2 mocks
- Complete the density analysis toolset

However, they are not blocking for basic density analysis functionality.

---

## References

- **GitHub Issue**: https://github.com/thomjeff/run-density/issues/280
- **Parent Issue**: #279 (RF-FE-002 - New Multi-Page Web UI)
- **Architecture Decision**: `cursor/chatgpt/TECHNICAL_ARCHITECTURE_DECISION_RF-FE-002.md`
- **Step 3 Completion**: `cursor/chatgpt/STEP3_COMPLETION_SUMMARY.md`
- **Step 8 Completion**: `cursor/chatgpt/STEP8_COMPLETION_SUMMARY.md`
- **Current Branch**: `feature/rf-fe-002`

---

**Status**: ✅ Issue created and linked to parent #279  
**Next Step**: Awaiting ChatGPT implementation plan for heatmap/bin-level features

