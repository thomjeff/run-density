# Critical Configuration - Things We Must Never Forget

This document captures critical configuration details that are essential for the application to function correctly and must never be forgotten or changed without careful consideration.

## Start Times Configuration

### CRITICAL: Event Start Times Must Be in Minutes from Midnight

**This is a non-negotiable requirement that has caused issues multiple times.**

### Correct Start Times Format:
```python
start_times = {
    '10K': 420,   # 7:00 AM (7 * 60 = 420 minutes from midnight)
    'Half': 440,  # 7:20 AM (7 * 60 + 20 = 440 minutes from midnight)
    'Full': 460   # 7:40 AM (7 * 60 + 40 = 460 minutes from midnight)
}
```

### What NOT to Use:
- ❌ Hours as decimals (7.0, 7.33, 7.67)
- ❌ Seconds from midnight (25200, 26400, 27600)
- ❌ Any other time format

### Why This Matters:
1. **density_report.py** expects start times in minutes from midnight
2. **temporal_flow_report.py** expects start times in minutes from midnight
3. **All report generation** depends on this format
4. **Wrong format causes errors** like "hour must be in 0..23"

### Historical Context:
- Reports were working correctly on 2025-09-04 with these exact values
- Multiple attempts to use other formats have failed
- This is a recurring issue that must be documented

### Testing Requirements:
When testing report generation, ALWAYS use:
```python
start_times = {'10K': 420, 'Half': 440, 'Full': 460}
```

## File Naming Conventions

### Data Files:
- `data/runners.csv` (formerly `your_pace_data.csv`)
- `data/flow.csv` (formerly `segments.csv`)
- `data/density.csv` (unchanged)

### Report Modules:
- `app/temporal_flow_report.py` (for temporal flow reports)
- `app/density_report.py` (for density analysis reports)
- `app/report.py` (for combined reports)

### Report Output Files:
- `reports/analysis/*_Temporal_Flow_Report.md`
- `reports/analysis/temporal_flow_analysis_*.csv`
- `reports/analysis/*_Density_Analysis_Report.md`

## Testing Workflow

### What "Reports" Means:
**Reports** = Actual markdown (.md) and CSV (.csv) files generated by the application's report modules, NOT just JSON data or test files.

### Required Reports for Testing:
1. **Temporal Flow Report** - Markdown file using `temporal_flow_report.py`
2. **Temporal Flow CSV** - CSV data file (automatically generated)
3. **Density Analysis Report** - Markdown file using `density_report.py`

### Testing Commands:
```bash
# 1. Create virtual environment
python3 -m venv test_env && source test_env/bin/activate

# 2. Install dependencies
pip install -r requirements.txt

# 3. Generate reports with correct start times
python3 -c "
from app.temporal_flow_report import generate_temporal_flow_report
from app.density_report import generate_density_report

start_times = {'10K': 420, 'Half': 440, 'Full': 460}  # 7:00, 7:20, 7:40 AM

# Generate temporal flow report
temporal_result = generate_temporal_flow_report('data/runners.csv', 'data/flow.csv', start_times)

# Generate density report  
density_result = generate_density_report('data/runners.csv', 'data/density.csv', start_times)
"
```

## Architecture Principles

### Module Separation:
- **Flow analysis** (`app/flow.py`) - temporal flow calculations
- **Density analysis** (`app/density.py`) - density calculations
- **Report generation** (`app/temporal_flow_report.py`, `app/density_report.py`) - report creation
- **API endpoints** (`app/main.py`) - web interface

### Data Sources:
- `segments.csv` (now `flow.csv`) - source of truth for width_m parameters
- `density.csv` - event-specific km ranges for density analysis
- `runners.csv` - runner pace data

### Non-Negotiable Requirements:
- Overtakes must be counted precisely (real temporal overlaps only)
- Use 'flow' to describe temporal_flow output
- Smaller modules with strict functional separation
- Always include automated and unit tests
- Avoid hardcoding configuration values

## Issue Completion Workflow

**CRITICAL: After completing an Issue and all of its sub-issues, ALWAYS follow these 7 steps:**

### 0. Create Development Branch (FIRST STEP)
- Create new development branch for the issue (e.g., v1.6.2-dev)
- Branch should be based on latest main
- All work for the issue should be done on this branch
- **This is the FIRST step before any development work**

### 1. Update CHANGELOG.md
- Add comprehensive entry documenting all changes
- Include technical implementation details and commit history
- Follow existing changelog format and structure

### 2. Commit Changes
- Commit all remaining changes (CHANGELOG.md, documentation updates, etc.)
- Use descriptive commit messages referencing the issue
- Ensure all work is properly committed before creating PR

### 3. Create Pull Request
- Create PR from feature branch to main
- Include comprehensive description with objectives, changes, and testing results
- Link to the original issue
- Use clear, descriptive PR title

### 4. Merge PR to Main
- Review PR for completeness
- Merge to main branch (preferably with merge commit for history)
- Delete feature branch after merge

### 5. Monitor GitHub Workflow
- Watch GitHub Actions workflow for deployment
- Monitor build, test, and deployment status
- Review Cloud Run logs if deployment issues occur
- Ensure successful deployment before proceeding

### 6. Run End-to-End Tests Using API
- Test all API endpoints through main.py (NOT direct module calls)
- Verify all functionality works through the web interface
- Test report generation endpoints specifically
- Confirm all endpoints return 200 status codes

### 7. Verify Reports and Human-Readability
- Generate all 3 report types (temporal_flow.md, temporal_flow.csv, density.md)
- Verify report content quality and human-readability
- Confirm proper event names, segment names, and formatting
- Ensure no generic names, NaN values, or formatting issues
- Validate actual results match expectations

**This workflow ensures quality, reliability, and proper deployment for every issue completion.**

## Common Pitfalls to Avoid

1. **Start Times Format** - Always use minutes from midnight (420, 440, 460)
2. **File References** - Use new file names (runners.csv, flow.csv)
3. **Report Generation** - Use actual report modules, not temporary code
4. **Testing** - Generate real markdown/CSV reports, not JSON data
5. **Import References** - Update all imports after file renames
6. **API Testing** - Always test through main.py APIs, not direct module calls
7. **JSON Serialization** - Watch for NaN values that break API responses
8. **Issue Completion Workflow** - ALWAYS follow the 7-step workflow above
9. **Development Branch** - ALWAYS create a new branch for each parent issue before starting work

## Last Updated
2025-09-05 - Added start times configuration and testing workflow

## Related Issues
- #32 - Distance gaps fix
- #33 - Density diagnostics logging  
- #34 - File renames
- #35, #36, #37 - Testing sub-issues
