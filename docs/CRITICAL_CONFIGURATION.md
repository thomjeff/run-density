# Critical Configuration - Development and Deployment

This document captures critical configuration details, workflows, and operational requirements that are essential for the application to function correctly and must never be forgotten or changed without careful consideration.

## Core Application Knowledge

**IMPORTANT**: For fundamental application concepts (start times, data structures, time calculations), see `docs/Application Fundamentals.md`. This document focuses on configuration and workflow.

## Testing Configuration

## Testing Workflow

### What "Reports" Means:
**Reports** = Actual markdown (.md) and CSV (.csv) files generated by the application's report modules, NOT just JSON data or test files.

### Required Reports for Testing:
1. **Temporal Flow Report** - Markdown file using `temporal_flow_report.py`
2. **Temporal Flow CSV** - CSV data file (automatically generated)
3. **Density Analysis Report** - Markdown file using `density_report.py`

### Testing Commands:
```bash
# 1. Create virtual environment
python3 -m venv test_env && source test_env/bin/activate

# 2. Install dependencies
pip install -r requirements.txt

# 3. Generate reports with correct start times
python3 -c "
from app.temporal_flow_report import generate_temporal_flow_report
from app.density_report import generate_density_report

start_times = {'10K': 420, 'Half': 440, 'Full': 460}  # 7:00, 7:20, 7:40 AM

# Generate temporal flow report
temporal_result = generate_temporal_flow_report('data/runners.csv', 'data/flow.csv', start_times)

# Generate density report  
density_result = generate_density_report('data/runners.csv', 'data/density.csv', start_times)
"
```

### Comprehensive End-to-End Testing (RECOMMENDED):
```bash
# 1. Create virtual environment
python3 -m venv test_env && source test_env/bin/activate

# 2. Install dependencies
pip install -r requirements.txt

# 3. Run comprehensive end-to-end tests
python3 -c "
from app.end_to_end_testing import run_comprehensive_tests
results = run_comprehensive_tests()
"

# Or run the module directly
python3 app/end_to_end_testing.py
```

### Individual Test Components:
```bash
# Test only API endpoints
python3 -c "
from app.end_to_end_testing import test_api_endpoints
results = test_api_endpoints()
"

# Test only report generation
python3 -c "
from app.end_to_end_testing import test_report_generation
results = test_report_generation()
"

# Test only report content quality
python3 -c "
from app.end_to_end_testing import test_report_content_quality
results = test_report_content_quality()
"
```

## Architecture Principles

### Module Separation:
- **Flow analysis** (`app/flow.py`) - temporal flow calculations
- **Density analysis** (`app/density.py`) - density calculations
- **Report generation** (`app/temporal_flow_report.py`, `app/density_report.py`) - report creation
- **API endpoints** (`app/main.py`) - web interface

### Data Sources:
- `segments.csv` (now `flow.csv`) - source of truth for width_m parameters
- `density.csv` - event-specific km ranges for density analysis
- `runners.csv` - runner pace data

### Non-Negotiable Requirements:
- Overtakes must be counted precisely (real temporal overlaps only)
- Use 'flow' to describe temporal_flow output
- Smaller modules with strict functional separation
- Always include automated and unit tests
- **NO HARDCODED VALUES** - This is a strict rule. Never use hardcoded values unless explicitly directed to do so. Always use proper dynamic calculations and configuration instead.

### Key Development Requirements:
- **MINIMAL CHANGES APPROACH** - When making changes, make only the minimal changes needed and test frequently.
- **TEST FREQUENTLY** - Test as often as possible and where it makes sense during development.
- **REFER TO APPLICATION FUNDAMENTALS** - For core concepts, see `docs/Application Fundamentals.md`

## CRITICAL AI ASSISTANT LEARNINGS (MUST NOT BE FORGOTTEN)

### **üö´ ENDLESS LOOPS - ABSOLUTE PROHIBITION**
- **NEVER** enter endless analysis loops where you repeatedly analyze the same code sections without taking action
- **NEVER** repeatedly identify the same bug without fixing it
- **STOP** immediately when user says "You're looping" or "You seem stuck"
- **TAKE ACTION** instead of endless analysis - if you see a bug, fix it immediately
- **RECOGNIZE PATTERNS**: If you've analyzed the same issue 3+ times, STOP and act

### **üîß PERMANENT VS TEMPORARY CODE**
- **ALWAYS** modify permanent modules (`app/temporal_flow_report.py`, `app/density_report.py`) instead of creating temporary scripts
- **ASK** if unsure whether code should be permanent or temporary
- **AVOID** creating standalone scripts for functionality that could be permanent
- **PRINCIPLE**: If functionality will be used repeatedly, it belongs in permanent modules

### **üêõ CRITICAL BUG PATTERNS**
- **TYPO BUGS**: Simple typos can cause massive regressions (e.g., `'flow-type'` vs `'flow_type'`)
- **ALWAYS** check for typos in variable names, especially when debugging data flow issues
- **VERIFY** that data is flowing correctly through the entire pipeline
- **TEST** immediately after fixing bugs to ensure the fix works

### **‚è±Ô∏è PERFORMANCE & TESTING**
- **ANALYSIS TAKES TIME**: Complex analysis (temporal flow, density) can take several minutes
- **DON'T INTERRUPT** long-running processes unless there's a clear error
- **BE PATIENT** with computationally intensive operations
- **VERIFY SUCCESS**: Check that files are generated and contain expected data

### **üìä REPORT QUALITY STANDARDS**
- **HUMAN READABILITY**: All reports must be formatted for human consumption
- **CONSISTENT DECIMALS**: Use max 3 decimal places, remove trailing zeros
- **NO "N/A" VALUES**: Replace with actual values or meaningful defaults
- **NORMALIZED VALUES**: Use 0.0-1.0 ranges for normalized metrics
- **PERCENTAGES**: Always include percentage calculations where relevant

### **üîÑ WORKFLOW DISCIPLINE**
- **COMMIT FREQUENTLY**: Make commits after testing and verification
- **USE DEV BRANCHES**: Work on version branches (e.g., v1.6.2-dev)
- **DOCUMENT CHANGES**: Always update CRITICAL_CONFIGURATION.md with new learnings
- **TEST COMPREHENSIVELY**: Run end-to-end tests before considering work complete

## Issue Completion Workflow

**CRITICAL: After completing an Issue and all of its sub-issues, ALWAYS follow these 7 steps:**

### 0. Create Development Branch (FIRST STEP)
- Create new development branch for the issue (e.g., v1.6.2-dev)
- Branch should be based on latest main
- All work for the issue should be done on this branch
- **This is the FIRST step before any development work**

### 1. Update CHANGELOG.md
- Add comprehensive entry documenting all changes
- Include technical implementation details and commit history
- Follow existing changelog format and structure

### 2. Commit Changes
- Commit all remaining changes (CHANGELOG.md, documentation updates, etc.)
- Use descriptive commit messages referencing the issue
- Ensure all work is properly committed before creating PR

### 3. Create Pull Request
- Create PR from feature branch to main
- Include comprehensive description with objectives, changes, and testing results
- Link to the original issue
- Use clear, descriptive PR title

### 4. Merge PR to Main
- Review PR for completeness
- Merge to main branch (preferably with merge commit for history)
- Delete feature branch after merge

### 5. Monitor GitHub Workflow
- Watch GitHub Actions workflow for deployment
- Monitor build, test, and deployment status
- Review Cloud Run logs if deployment issues occur
- Ensure successful deployment before proceeding

### 6. Run End-to-End Tests Using API
- Test all API endpoints through main.py (NOT direct module calls)
- Verify all functionality works through the web interface
- Test report generation endpoints specifically
- Confirm all endpoints return 200 status codes

### 7. Verify Reports and Human-Readability
- Generate all 3 report types (temporal_flow.md, temporal_flow.csv, density.md)
- Verify report content quality and human-readability
- Confirm proper event names, segment names, and formatting
- Ensure no generic names, NaN values, or formatting issues
- Validate actual results match expectations

**This workflow ensures quality, reliability, and proper deployment for every issue completion.**

## Common Pitfalls to Avoid

1. **File References** - Use correct file names (runners.csv, segments_new.csv)
2. **Report Generation** - Use actual report modules, not temporary code
3. **Testing** - Generate real markdown/CSV reports, not JSON data
4. **Import References** - Update all imports after file renames
5. **API Testing** - Always test through main.py APIs, not direct module calls
6. **JSON Serialization** - Watch for NaN values that break API responses
7. **Issue Completion Workflow** - ALWAYS follow the 7-step workflow above
8. **Development Branch** - ALWAYS create a new branch for each parent issue before starting work
9. **HARDCODED VALUES** - NEVER use hardcoded values unless explicitly directed. This is a critical rule that has been emphasized multiple times.
10. **Application Fundamentals** - Refer to `docs/Application Fundamentals.md` for core concepts

## Last Updated
2025-09-05 - Added start times configuration and testing workflow

## Related Issues
- #32 - Distance gaps fix
- #33 - Density diagnostics logging  
- #34 - File renames
- #35, #36, #37 - Testing sub-issues
