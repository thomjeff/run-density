# Captions on Density Heatmaps (Finalize Auto‑Captions Pipeline)

Status: OPEN  
Related: #280 (closed, authoritative spec), #318, #279  
Owner: Cursor Dev (under Senior Architect guidance)

---

## Objective
Complete the auto‑caption feature for density heatmaps by finishing the captions generation logic and reconnecting it to the API and UI. This implements the authoritative rules from Issue #280 while respecting repo guardrails and SSOT configs.

---

## Scope of Work

### 1) Preparation
- Verify branch is up to date and that `captions.json` exists but has empty `waves`, `clearance_time`, and `label` fields; UI caption rendering was previously removed.
- Add caption thresholds to config (no hardcoding):
  - `config/density_rulebook.yml` or a small dedicated section in a new `config/captioning.yml` if preferred:
    - `wave_gap_minutes: 5`
    - `clearance_threshold_p_m2: 0.10`
    - `clearance_sustain_minutes: 6`
    - `similarity_pct: 0.10`
    - `spread_pct: 0.20`
  - `config/reporting.yml`: qualitative label mapping (bands/text) if needed for UI phrasing.

### 2) Backend Logic (analytics)
Implement/finish `export_segment_captions(run_id, artifacts_root)` in `analytics/export_frontend_artifacts.py` using `artifacts/<run_id>/bin_summary.json` as input (not arrivals from `segments.csv`).

- Column normalization and parsing:
  - Use canonical aliases from #280: `segment_id`, `t_start`, `t_end`, `start_km`, `end_km`, `density`.
  - Parse times to event‑local; display as `HH:MM`.
- Wave detection (authoritative rule from #280):
  - Sort bins by `t_start`.
  - New wave when `(next.t_start - prev.t_end) > wave_gap_minutes` (end→start gap). Overlaps (gap ≤ 0) stay in the same wave.
- Peak and location:
  - Global max density across bins; LOS band from `config/density_rulebook.yml`.
  - Format location as `"a–b km"` using one decimal.
- Clearance detection (sustained window):
  - Build a 1‑minute series per segment.
  - For each minute, compute max density across all distance bins.
  - Clearance time is earliest `T` where every minute in `[T, T+clearance_sustain_minutes)` has `max_density ≤ clearance_threshold_p_m2`.
  - Minutes with no coverage are unknown; skip such windows. If none found, `null`.
- Qualitative descriptors (optional when confident):
  - Heavier/lighter/similar by ±`similarity_pct` of prior wave peak.
  - Dispersed/concentrated/similar by ±`spread_pct` of spread score (unique minutes × unique distance bins).
  - Omit adjectives if marginal data.
- Summary text:
  - Deterministic, concise narrative per #280 examples (single‑wave and multi‑wave templates).
- Output schema per #280:
  - Required: `seg_id`, `label`, `summary`, `peak{density_p_m2,time,km_range,los}`, `waves[]`, `clearance_time`, `notes`.
  - Always emit JSON object; never crash. Minimal caption with notes when data sparse.

### 3) Storage and API
- Ensure a small helper exists to load captions via the unified storage abstraction (`app/storage.py`).
- Extend `/api/density/segment/<seg_id>` in `app/routes/api_density.py` to include:
  - `caption` (summary string), and optionally `waves`, `peak`, `clearance` (for future richer UI).
- Do not fetch raw `captions.json` from the UI; keep templates thin and API‑driven.

### 4) UI
- In `templates/pages/density.html`, render `segment.caption` beneath the heatmap (restore previously removed behavior).
- Optional: a simple “Show captions” toggle that hides/shows the caption div (no new data fetch).

### 5) Tests & Validation
- Unit tests (`tests/test_export_segment_captions.py`):
  - Wave split rule, sustained clearance window, qualitative thresholds, and schema.
- API tests (`tests/test_api_density_segment.py`):
  - Caption present and non‑empty when available; null when absent.
- UI tests (`tests/test_ui_pages_density.py`):
  - Caption renders; toggle hides/shows.
- QC test (`tests/test_ui_artifacts_qc.py`):
  - `captions.json` schema validation.
- E2E per guardrails:
  - `python e2e.py --local` and Cloud validation; verify `/density` shows captions beneath heatmaps and that artifacts are produced.

---

## Acceptance Criteria
- `export_segment_captions` populates `waves`, `clearance_time`, and `summary/label` deterministically from `bin_summary.json`.
- `/api/density/segment/<seg_id>` includes `caption` (and remains backward‑compatible).
- `/density` page displays caption beneath the heatmap; toggle (if added) functions.
- No hardcoded thresholds; all values sourced from config.
- Unit, API, UI, and E2E validations pass.

---

## Non‑Goals
- New visualization libraries or client‑side heatmap logic.
- Direct UI access to artifact files.
- Reintroducing bin‑level details table (tracked in #318).

---

## Risks & Mitigations
- Sparse data can reduce confidence → emit minimal caption with `notes` and avoid adjectives.
- Clearance may not be provable in window → set `clearance_time=null` with explanatory note.
- UI clutter → keep caption beneath heatmap; avoid map overlays in this issue.

---

## Implementation Notes
- Small, testable edits only; dev branch; PR with E2E proof.
- Reuse SSOT configs: `config/density_rulebook.yml`, `config/reporting.yml`.
- Follow Issue #280’s algorithms exactly; this issue completes the remaining wiring.
