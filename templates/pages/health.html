{% extends "base.html" %}

{% block title %}Health Check{% endblock %}

{% block content %}
<div class="page-header">
    <h2>System Health</h2>
    {% if meta %}
    <div class="provenance">
        {% include "partials/_provenance.html" %}
    </div>
    {% endif %}
</div>

<!-- Environment Status -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Environment</h3>
    <div style="display: flex; align-items: center; gap: 1rem;">
        <span id="env-pill" style="padding: 0.5rem 1rem; background: #2ecc71; color: white; border-radius: 20px; font-weight: 600;">
            {{ meta.environment|upper if meta else "UNKNOWN" }}
        </span>
        <span style="color: #7f8c8d; font-size: 0.875rem;">
            Last updated: {{ meta.run_timestamp if meta else "N/A" }}
        </span>
    </div>
</div>

<!-- File Presence Checks -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Data Files</h3>
    <table id="file-status-table">
        <thead>
            <tr>
                <th>File</th>
                <th>Status</th>
                <th>Modified</th>
            </tr>
        </thead>
        <tbody id="file-status-tbody">
            <tr>
                <td colspan="3" class="placeholder">Loading data status...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Configuration Hashes -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Configuration</h3>
    <table>
        <tbody>
            <tr>
                <td><strong>Rulebook Hash</strong></td>
                <td id="rulebook-hash">{{ meta.rulebook_hash[:16] if meta and meta.rulebook_hash else "N/A" }}...</td>
            </tr>
            <tr>
                <td><strong>Reporting Hash</strong></td>
                <td id="reporting-hash">{{ meta.reporting_hash[:16] if meta and meta.reporting_hash else "N/A" }}...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- API Endpoint Checks -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">API Endpoints</h3>
    <table id="endpoint-status-table">
        <thead>
            <tr>
                <th>Endpoint</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>GET /health</td>
                <td id="status-health" class="placeholder">Checking...</td>
            </tr>
            <tr>
                <td>GET /api/segments</td>
                <td id="status-api-segments" class="placeholder">Checking...</td>
            </tr>
            <tr>
                <td>GET /api/summary</td>
                <td id="status-api-summary" class="placeholder">Checking...</td>
            </tr>
        </tbody>
    </table>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Load data health status
    document.addEventListener('DOMContentLoaded', function() {
        loadDataHealth();
    });
    
    function loadDataHealth() {
        fetch('/api/health/data')
            .then(response => response.json())
            .then(data => {
                updateFileStatusTable(data);
            })
            .catch(error => {
                console.error('Error loading data health:', error);
                showHealthError();
            });
    }
    
    function updateFileStatusTable(data) {
        const tbody = document.getElementById('file-status-tbody');
        tbody.innerHTML = '';
        
        // Filter out storage metadata
        const fileData = Object.entries(data).filter(([key, value]) => key !== '_storage');
        
        fileData.forEach(([filename, info]) => {
            const row = document.createElement('tr');
            
            const statusClass = info.exists ? 'status-ok' : 'status-error';
            const statusText = info.exists ? '✅ Found' : '❌ Missing';
            const mtimeText = info.mtime && info.mtime !== 'error' ? formatTimestamp(info.mtime) : '—';
            
            row.innerHTML = `
                <td>${filename}</td>
                <td class="${statusClass}">${statusText}</td>
                <td>${mtimeText}</td>
            `;
            
            tbody.appendChild(row);
        });
        
        // Add storage info if available
        if (data._storage) {
            const storageRow = document.createElement('tr');
            storageRow.innerHTML = `
                <td><strong>Storage Mode</strong></td>
                <td class="status-ok">${data._storage.mode}</td>
                <td>${data._storage.root || data._storage.bucket || '—'}</td>
            `;
            tbody.appendChild(storageRow);
        }
    }
    
    function showHealthError() {
        const tbody = document.getElementById('file-status-tbody');
        tbody.innerHTML = '<tr><td colspan="3" class="placeholder">Error loading data status</td></tr>';
    }
    
    function formatTimestamp(timestamp) {
        try {
            const date = new Date(timestamp);
            return date.toLocaleString();
        } catch (e) {
            return timestamp;
        }
    }
</script>
{% endblock %}

{% block extra_styles %}
<style>
    #env-pill {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.85; }
    }
    
    .status-ok {
        color: #2ecc71;
        font-weight: 600;
    }
    
    .status-error {
        color: #e74c3c;
        font-weight: 600;
    }
</style>
{% endblock %}

