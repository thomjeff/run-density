{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Generated Reports</h2>
    {% if meta %}
    {% endif %}
</div>

<!-- Reports Section -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Reports</h3>
    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
        Generated Density and Flow analysis reports, sorted by most recent first.
    </p>
    <div id="reports-list">
        <p class="placeholder">Loading reports...</p>
    </div>
</div>

<!-- Data Files Section -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Data Files</h3>
    <p style="margin-bottom: 1rem; color: #666; font-size: 0.9rem;">
        Input data files used for analysis and validation.
    </p>
    <div id="data-files-list">
        <p class="placeholder">Loading data files...</p>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Load reports on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadReports();
    });
    
    function loadReports() {
        fetch('/api/reports/list')
            .then(response => response.json())
            .then(data => {
                renderReportsList(data);
            })
            .catch(error => {
                console.error('Error loading reports:', error);
                showReportsError();
            });
    }
    
    function renderReportsList(reports) {
        const reportsContainer = document.getElementById('reports-list');
        const dataFilesContainer = document.getElementById('data-files-list');
        
        if (!reports || reports.length === 0) {
            reportsContainer.innerHTML = '<p class="placeholder">No reports available</p>';
            dataFilesContainer.innerHTML = '<p class="placeholder">No data files available</p>';
            return;
        }
        
        // Filter and categorize files
        const relevantReports = reports.filter(r => {
            // Include only Density and Flow reports (.md and .csv files)
            const isRelevantReport = (r.name.includes('Density') || r.name.includes('Flow')) && 
                                   (r.name.endsWith('.md') || r.name.endsWith('.csv'));
            
            // Exclude technical files
            const isTechnicalFile = r.name.includes('bins.') || 
                                  r.name.includes('map_data_') || 
                                  r.name.includes('segment_windows_') ||
                                  r.name.includes('segments_legacy_') ||
                                  r.name.endsWith('.parquet') ||
                                  r.name.endsWith('.geojson') ||
                                  r.name.endsWith('.json');
            
            return isRelevantReport && !isTechnicalFile;
        });
        
        const dataFiles = reports.filter(r => r.type === 'data_file');
        
        // Sort by modification time (newest first)
        const sortByNewest = (a, b) => {
            const timeA = a.mtime || 0;
            const timeB = b.mtime || 0;
            return timeB - timeA; // Descending order (newest first)
        };
        
        relevantReports.sort(sortByNewest);
        dataFiles.sort(sortByNewest);
        
        // Render Reports Section
        if (relevantReports.length > 0) {
            let reportsHtml = '<table style="width: 100%; border-collapse: collapse; table-layout: fixed;">';
            reportsHtml += '<thead><tr>';
            reportsHtml += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 45%;">File</th>';
            reportsHtml += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 12%;">Size</th>';
            reportsHtml += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 28%;">Modified</th>';
            reportsHtml += '<th style="text-align: center; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 15%;">Action</th>';
            reportsHtml += '</tr></thead><tbody>';
            
            relevantReports.forEach(report => {
                reportsHtml += renderReportTableRow(report);
            });
            
            reportsHtml += '</tbody></table>';
            reportsContainer.innerHTML = reportsHtml;
        } else {
            reportsContainer.innerHTML = '<p class="placeholder">No reports available</p>';
        }
        
        // Render Data Files Section
        if (dataFiles.length > 0) {
            let dataFilesHtml = '<table style="width: 100%; border-collapse: collapse; table-layout: fixed;">';
            dataFilesHtml += '<thead><tr>';
            dataFilesHtml += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 45%;">File</th>';
            dataFilesHtml += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 12%;">Size</th>';
            dataFilesHtml += '<th style="text-align: left; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 28%;">Modified</th>';
            dataFilesHtml += '<th style="text-align: center; padding: 0.75rem; border-bottom: 2px solid #e0e0e0; font-weight: 600; width: 15%;">Action</th>';
            dataFilesHtml += '</tr></thead><tbody>';
            
            dataFiles.forEach(file => {
                dataFilesHtml += renderDataFileTableRow(file);
            });
            
            dataFilesHtml += '</tbody></table>';
            dataFilesContainer.innerHTML = dataFilesHtml;
        } else {
            dataFilesContainer.innerHTML = '<p class="placeholder">No data files available</p>';
        }
    }
    
    function renderReportTableRow(report) {
        const size = formatFileSize(report.size);
        const mtime = report.mtime ? new Date(report.mtime * 1000).toLocaleString() : 'N/A';
        
        return `
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 0.75rem;">
                    <div style="font-weight: 600; color: #2c3e50;">${report.name}</div>
                    <div style="font-size: 0.875rem; color: #7f8c8d; margin-top: 0.25rem;">${report.description || 'Report file'}</div>
                </td>
                <td style="padding: 0.75rem; color: #666;">${size}</td>
                <td style="padding: 0.75rem; color: #666;">${mtime}</td>
                <td style="padding: 0.75rem; text-align: center;">
                    <a href="/api/reports/download?path=${encodeURIComponent(report.path)}" 
                       class="button"
                       download="${report.name}"
                       style="padding: 0.5rem 1rem; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-size: 0.875rem;">
                        Download
                    </a>
                </td>
            </tr>
        `;
    }
    
    function renderDataFileTableRow(file) {
        const size = formatFileSize(file.size);
        const mtime = file.mtime ? new Date(file.mtime * 1000).toLocaleString() : 'N/A';
        
        return `
            <tr style="border-bottom: 1px solid #e0e0e0;">
                <td style="padding: 0.75rem;">
                    <div style="font-weight: 600; color: #2c3e50;">${file.name}</div>
                    <div style="font-size: 0.875rem; color: #7f8c8d; margin-top: 0.25rem;">${file.description || 'Data file'}</div>
                </td>
                <td style="padding: 0.75rem; color: #666;">${size}</td>
                <td style="padding: 0.75rem; color: #666;">${mtime}</td>
                <td style="padding: 0.75rem; text-align: center;">
                    <a href="/api/reports/download?path=${encodeURIComponent(file.path)}" 
                       class="button"
                       download="${file.name}"
                       style="padding: 0.5rem 1rem; background: #3498db; color: white; text-decoration: none; border-radius: 4px; font-size: 0.875rem;">
                        Download
                    </a>
                </td>
            </tr>
        `;
    }
    
    function formatFileSize(bytes) {
        if (!bytes) return 'N/A';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function showReportsError() {
        const reportsContainer = document.getElementById('reports-list');
        const dataFilesContainer = document.getElementById('data-files-list');
        reportsContainer.innerHTML = '<p class="placeholder">Error loading reports</p>';
        dataFilesContainer.innerHTML = '<p class="placeholder">Error loading data files</p>';
    }
</script>
{% endblock %}

{% block extra_styles %}
<style>
    .button:hover {
        background: #2980b9;
    }
</style>
{% endblock %}
